 /*
  * MainForm.java
  *
  * Основная форма приложения
  */
 package ricoko.arismorf;
 
 import java.awt.Desktop;
 import java.io.IOException;
 import java.util.logging.Level;
 import java.util.logging.Logger;
 import ricoko.arismorf.extractors.ExtractorOsh1;
 import java.io.File;
 import java.sql.Connection;
 import java.sql.Statement;
 import javax.swing.JFileChooser;
 import javax.swing.JFrame;
 import javax.swing.filechooser.FileFilter;
 import javax.swing.text.DefaultCaret;
 import ricoko.arismorf.extractors.Extractor83rikp;
 import ricoko.arismorf.extractors.ExtractorOsh5;
 
 /**
  * @author maksimenkov (xupypr@xupypr.com)
  */
 public class MainForm extends javax.swing.JFrame {
 
     public static final String YEAR = "2011";
 
     /** Creates new form MainForm */
     public MainForm() {
         initComponents();
     }
 
     /** This method is called from within the constructor to
      * initialize the form.
      * WARNING: Do NOT modify this code. The content of this method is
      * always regenerated by the Form Editor.
      */
     @SuppressWarnings("unchecked")
     // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
     private void initComponents() {
 
         logScrollPane = new javax.swing.JScrollPane();
         logTextArea = new javax.swing.JTextArea();
         logLabel = new javax.swing.JLabel();
         mainMenu = new javax.swing.JMenuBar();
         convAtoMButton = new javax.swing.JMenu();
         importARISMO = new javax.swing.JMenuItem();
         exportMORFmenu = new javax.swing.JMenu();
         exportMORF = new javax.swing.JMenuItem();
         jSeparator1 = new javax.swing.JPopupMenu.Separator();
         exportMORFOsh1 = new javax.swing.JMenuItem();
         exportMORFOsh5 = new javax.swing.JMenuItem();
         exportMORF83rikp = new javax.swing.JMenuItem();
         separator1 = new javax.swing.JMenu();
         convMtoAButton = new javax.swing.JMenu();
         separator4 = new javax.swing.JMenu();
         databaseButton = new javax.swing.JMenu();
         reloadDictionariesButton = new javax.swing.JMenuItem();
         refreshDatabaseButton = new javax.swing.JMenuItem();
         separator3 = new javax.swing.JMenu();
         helpButton = new javax.swing.JMenu();
         jMenuItem1 = new javax.swing.JMenuItem();
 
         setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
         setTitle("Конвертатор: АРИСМО <-> МОРФ (версия 0.1)");
         addWindowListener(new java.awt.event.WindowAdapter() {
             public void windowClosed(java.awt.event.WindowEvent evt) {
                 formWindowClosed(evt);
             }
         });
 
         logTextArea.setColumns(20);
         logTextArea.setEditable(false);
         logTextArea.setRows(5);
         logTextArea.addInputMethodListener(new java.awt.event.InputMethodListener() {
             public void caretPositionChanged(java.awt.event.InputMethodEvent evt) {
             }
             public void inputMethodTextChanged(java.awt.event.InputMethodEvent evt) {
                 logTextAreaInputMethodTextChanged(evt);
             }
         });
         logScrollPane.setViewportView(logTextArea);
         DefaultCaret caret = (DefaultCaret)logTextArea.getCaret();
         caret.setUpdatePolicy(DefaultCaret.ALWAYS_UPDATE);
 
         logLabel.setFont(new java.awt.Font("DejaVu Sans", 1, 13));
         logLabel.setText("Журнал :");
 
         mainMenu.setName("MainMenu"); // NOI18N
 
         convAtoMButton.setText("АРИСМО -> МОРФ");
 
         importARISMO.setText("Импорт из АРИСМО");
         importARISMO.addMouseListener(new java.awt.event.MouseAdapter() {
             public void mouseClicked(java.awt.event.MouseEvent evt) {
                 importARISMOMouseClicked(evt);
             }
         });
         importARISMO.addActionListener(new java.awt.event.ActionListener() {
             public void actionPerformed(java.awt.event.ActionEvent evt) {
                 importARISMOActionPerformed(evt);
             }
         });
         convAtoMButton.add(importARISMO);
 
         exportMORFmenu.setText("Экспорт");
 
         exportMORF.setText("Экспорт в МОРФ (полный)");
         exportMORF.addMouseListener(new java.awt.event.MouseAdapter() {
             public void mouseClicked(java.awt.event.MouseEvent evt) {
                 exportMORFMouseClicked(evt);
             }
         });
         exportMORF.addActionListener(new java.awt.event.ActionListener() {
             public void actionPerformed(java.awt.event.ActionEvent evt) {
                 exportMORFActionPerformed(evt);
             }
         });
         exportMORFmenu.add(exportMORF);
         exportMORFmenu.add(jSeparator1);
 
         exportMORFOsh1.setText("Форма № Ош-1");
         exportMORFOsh1.addActionListener(new java.awt.event.ActionListener() {
             public void actionPerformed(java.awt.event.ActionEvent evt) {
                 exportMORFOsh1ActionPerformed(evt);
             }
         });
         exportMORFmenu.add(exportMORFOsh1);
 
         exportMORFOsh5.setText("Форма № Ош-5");
         exportMORFOsh5.addActionListener(new java.awt.event.ActionListener() {
             public void actionPerformed(java.awt.event.ActionEvent evt) {
                 exportMORFOsh5ActionPerformed(evt);
             }
         });
         exportMORFmenu.add(exportMORFOsh5);
 
         exportMORF83rikp.setText("Форма № 83-рик первичная");
         exportMORF83rikp.addActionListener(new java.awt.event.ActionListener() {
             public void actionPerformed(java.awt.event.ActionEvent evt) {
                 exportMORF83rikpActionPerformed(evt);
             }
         });
         exportMORFmenu.add(exportMORF83rikp);
 
         convAtoMButton.add(exportMORFmenu);
 
         mainMenu.add(convAtoMButton);
 
         separator1.setText("|");
         separator1.setEnabled(false);
         mainMenu.add(separator1);
 
         convMtoAButton.setText("МОРФ -> АРИСМО");
         convMtoAButton.setEnabled(false);
         mainMenu.add(convMtoAButton);
 
         separator4.setText("|");
         separator4.setEnabled(false);
         mainMenu.add(separator4);
 
         databaseButton.setText("База данных");
 
         reloadDictionariesButton.setText("Обновить справочники");
         reloadDictionariesButton.addActionListener(new java.awt.event.ActionListener() {
             public void actionPerformed(java.awt.event.ActionEvent evt) {
                 reloadDictionariesButtonActionPerformed(evt);
             }
         });
         databaseButton.add(reloadDictionariesButton);
 
         refreshDatabaseButton.setText("Очистить базу");
         refreshDatabaseButton.addActionListener(new java.awt.event.ActionListener() {
             public void actionPerformed(java.awt.event.ActionEvent evt) {
                 refreshDatabaseButtonActionPerformed(evt);
             }
         });
         databaseButton.add(refreshDatabaseButton);
 
         mainMenu.add(databaseButton);
 
         separator3.setText("|");
         separator3.setEnabled(false);
         mainMenu.add(separator3);
 
         helpButton.setText("Помощь");
         helpButton.addActionListener(new java.awt.event.ActionListener() {
             public void actionPerformed(java.awt.event.ActionEvent evt) {
                 helpButtonActionPerformed(evt);
             }
         });
 
         jMenuItem1.setText("Справка");
         jMenuItem1.addActionListener(new java.awt.event.ActionListener() {
             public void actionPerformed(java.awt.event.ActionEvent evt) {
                 jMenuItem1ActionPerformed(evt);
             }
         });
         helpButton.add(jMenuItem1);
 
         mainMenu.add(helpButton);
 
         setJMenuBar(mainMenu);
 
         javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
         getContentPane().setLayout(layout);
         layout.setHorizontalGroup(
             layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
             .addGroup(layout.createSequentialGroup()
                 .addContainerGap()
                 .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                     .addGroup(layout.createSequentialGroup()
                         .addComponent(logLabel)
                         .addContainerGap(725, Short.MAX_VALUE))
                     .addGroup(layout.createSequentialGroup()
                         .addComponent(logScrollPane, javax.swing.GroupLayout.DEFAULT_SIZE, 774, Short.MAX_VALUE)
                        .addGap(178, 178, 178))))
         );
         layout.setVerticalGroup(
             layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
             .addGroup(layout.createSequentialGroup()
                 .addContainerGap()
                 .addComponent(logLabel)
                 .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                 .addComponent(logScrollPane, javax.swing.GroupLayout.DEFAULT_SIZE, 414, Short.MAX_VALUE)
                 .addContainerGap())
         );
 
         pack();
     }// </editor-fold>//GEN-END:initComponents
 
 private void exportMORFMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_exportMORFMouseClicked
 }//GEN-LAST:event_exportMORFMouseClicked
 
 private void importARISMOMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_importARISMOMouseClicked
 }//GEN-LAST:event_importARISMOMouseClicked
 
 private void importARISMOActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_importARISMOActionPerformed
     final JFrame jf = this;
     Thread t = new Thread(new Runnable() {
 
         @Override
         public void run() {
             try {
                 JFileChooser fc = new JFileChooser();
                 FileFilter filter1 = new FileFilter() {
 
                     @Override
                     public boolean accept(File pathname) {
                         if (pathname.isFile()
                                 && (pathname.getName().endsWith("xml")
                                 || pathname.getName().endsWith("XML"))) {
                             return true;
                         } else {
                             return false;
                         }
                     }
 
                     @Override
                     public String getDescription() {
                         return "xml files";
                     }
                 };
                 fc.setFileFilter(filter1);
                 int returnVal = fc.showOpenDialog(jf);
                 if (returnVal == JFileChooser.APPROVE_OPTION) {
                     File file = fc.getSelectedFile();
                     XMLImport.getInstance(logTextArea, true).parseDocument(file);
                 }
             } catch (Exception e) {
                 logTextArea.append("Ошибка импорта: " + e.getMessage() + "\n");
                 for (StackTraceElement ste : e.getStackTrace()) {
                     logTextArea.append(ste.toString() + "\n");
                 }
             }
         }
     });
     t.start();
 }//GEN-LAST:event_importARISMOActionPerformed
 
 private void exportMORFActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_exportMORFActionPerformed
     exportMORFForm("all");
 }//GEN-LAST:event_exportMORFActionPerformed
 
 private void logTextAreaInputMethodTextChanged(java.awt.event.InputMethodEvent evt) {//GEN-FIRST:event_logTextAreaInputMethodTextChanged
 // TODO add your handling code here:
 }//GEN-LAST:event_logTextAreaInputMethodTextChanged
 
 private void refreshDatabaseButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_refreshDatabaseButtonActionPerformed
 
     final JFrame jf = this;
     Thread t = new Thread(new Runnable() {
 
         @Override
         public void run() {
             try {
                 Connection connection = MySQL.getConnection();
                 Statement statement = connection.createStatement();
                 logTextArea.append("Очищаю базу данных \n");
                 statement.execute("DROP DATABASE arismorf;");
                 statement.execute("CREATE DATABASE arismorf CHARACTER SET=cp1251;");
                 statement.execute("SET NAMES cp1251;");
                 statement.execute("USE arismorf;");
                 logTextArea.append("База данных очищена \n");
                 statement.close();
                 DatabaseStructure.dispose();
                 logTextArea.append("Восстанавливаю структуру таблиц \n");
                 XMLImport.getInstance(logTextArea, false).parseInit();
                 logTextArea.append("Структура таблиц восстановлена \n");
                 logTextArea.append("Восстанавливаю справочники \n");
                 XMLImport.getInstance(logTextArea, false).parseDocument(new File("./resources/db/dirs-openschool.xml"));
                 logTextArea.append("Справочники восстановлены \n");
             } catch (Exception e) {
                 logTextArea.append("Ошибка: " + e.getMessage() + "\n");
                 for (StackTraceElement ste : e.getStackTrace()) {
                     logTextArea.append(ste.toString() + "\n");
                 }
             }
         }
     });
     t.start();
 }//GEN-LAST:event_refreshDatabaseButtonActionPerformed
 
 private void reloadDictionariesButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_reloadDictionariesButtonActionPerformed
     importARISMOActionPerformed(evt);
 }//GEN-LAST:event_reloadDictionariesButtonActionPerformed
 
 private void formWindowClosed(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_formWindowClosed
     try {
         MySQL.stopMySQL();
     } catch (Exception ex) {
         ex.printStackTrace();
     }
 }//GEN-LAST:event_formWindowClosed
 
     private void exportMORFForm(final String formName) {
         Thread t = new Thread(new Runnable() {
 
             @Override
             public void run() {
                 try {
                     ExcelExport ee = new ExcelExport();
                     if (formName.equals("osh1") || formName.equals("all")) {
                         ExtractorOsh1.extract(MySQL.getConnection(), logTextArea, ee);
                     }
                     if (formName.equals("osh5") || formName.equals("all")) {
                         ExtractorOsh5.extract(MySQL.getConnection(), logTextArea, ee);
                     }
                     if (formName.equals("83rikp") || formName.equals("all")) {
                         Extractor83rikp.extract(MySQL.getConnection(), logTextArea, ee);
                     }
                     ee.saveExportedWorkBooks(logTextArea);
                     logTextArea.append("Экпорт завершен. Результаты экспорта располагаются в папке export.\n");
                     if (Desktop.isDesktopSupported()) {
                         Desktop.getDesktop().open(new File("export"));
                     }
                 } catch (Exception e) {
                     logTextArea.append("Ошибка экспорта: " + e.getMessage() + "\n");
                     for (StackTraceElement ste : e.getStackTrace()) {
                         logTextArea.append(ste.toString() + "\n");
                     }
                 }
             }
         });
         t.start();
     }
 
 private void exportMORFOsh1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_exportMORFOsh1ActionPerformed
     exportMORFForm("osh1");
 }//GEN-LAST:event_exportMORFOsh1ActionPerformed
 
 private void exportMORF83rikpActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_exportMORF83rikpActionPerformed
     exportMORFForm("83rikp");
 }//GEN-LAST:event_exportMORF83rikpActionPerformed
 
 private void exportMORFOsh5ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_exportMORFOsh5ActionPerformed
     exportMORFForm("osh5");
 }//GEN-LAST:event_exportMORFOsh5ActionPerformed
 
 private void helpButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_helpButtonActionPerformed
 
 }//GEN-LAST:event_helpButtonActionPerformed
 
 private void jMenuItem1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jMenuItem1ActionPerformed
     if (Desktop.isDesktopSupported()) {
         try {
             Desktop.getDesktop().open(new File("about.html"));
         } catch (IOException e) {
             logTextArea.append("Ошибка : " + e.getMessage() + "\n");
             for (StackTraceElement ste : e.getStackTrace()) {
                 logTextArea.append(ste.toString() + "\n");
             }
         }
     }
 }//GEN-LAST:event_jMenuItem1ActionPerformed
 
     /**
      * @param args the command line arguments
      */
     public static void main(String args[]) throws Exception {
         MySQL.startMySQL();
         java.awt.EventQueue.invokeLater(new Runnable() {
 
             public void run() {
                 new MainForm().setVisible(true);
             }
         });
     }
     // Variables declaration - do not modify//GEN-BEGIN:variables
     private javax.swing.JMenu convAtoMButton;
     private javax.swing.JMenu convMtoAButton;
     private javax.swing.JMenu databaseButton;
     private javax.swing.JMenuItem exportMORF;
     private javax.swing.JMenuItem exportMORF83rikp;
     private javax.swing.JMenuItem exportMORFOsh1;
     private javax.swing.JMenuItem exportMORFOsh5;
     private javax.swing.JMenu exportMORFmenu;
     private javax.swing.JMenu helpButton;
     private javax.swing.JMenuItem importARISMO;
     private javax.swing.JMenuItem jMenuItem1;
     private javax.swing.JPopupMenu.Separator jSeparator1;
     private javax.swing.JLabel logLabel;
     private javax.swing.JScrollPane logScrollPane;
     private javax.swing.JTextArea logTextArea;
     private javax.swing.JMenuBar mainMenu;
     private javax.swing.JMenuItem refreshDatabaseButton;
     private javax.swing.JMenuItem reloadDictionariesButton;
     private javax.swing.JMenu separator1;
     private javax.swing.JMenu separator3;
     private javax.swing.JMenu separator4;
     // End of variables declaration//GEN-END:variables
 }
