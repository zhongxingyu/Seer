 package interiores.presentation.swing.views;
 
 import interiores.business.controllers.BinaryConstraintController;
 import interiores.business.controllers.FurnitureModelController;
 import interiores.business.controllers.FurnitureTypeController;
 import interiores.business.controllers.RoomController;
 import interiores.business.controllers.UnaryConstraintController;
 import interiores.business.models.Orientation;
 import interiores.business.models.constraints.UnaryConstraint;
 import interiores.business.events.constraints.ConstraintAddedEvent;
 import interiores.business.events.constraints.ConstraintRemovedEvent;
 import interiores.core.Debug;
 import interiores.core.presentation.SwingController;
 import interiores.core.presentation.annotation.Listen;
 import interiores.utils.BinaryConstraintAssociation;
 import interiores.utils.CoolColor;
 import interiores.utils.Material;
 import java.awt.event.KeyEvent;
 import java.util.ArrayList;
 import java.util.Collection;
 import javax.swing.JComboBox;
 import javax.swing.JFrame;
 import javax.swing.JList;
 import javax.swing.SpinnerNumberModel;
 
 /**
  *
  * @author alvaro
  */
 public class ConstraintEditorFrame extends JFrame {
 
     private String selectedId;
     private FurnitureTypeController furnitureTypeController;
     private FurnitureModelController furnitureModelController;
     private UnaryConstraintController unaryConstraintController;
     private BinaryConstraintController binaryConstraintController;
     private Collection<String> relatableFurniture;
     
     /** Creates new form ConstraintEditorFrame */
     public ConstraintEditorFrame(SwingController presentation) {
         initComponents();
         
         furnitureTypeController = presentation.getBusinessController(FurnitureTypeController.class);
         furnitureModelController = presentation.getBusinessController(FurnitureModelController.class);
         unaryConstraintController = presentation.getBusinessController(UnaryConstraintController.class);
         binaryConstraintController = presentation.getBusinessController(BinaryConstraintController.class);
         
         RoomController roomController = presentation.getBusinessController(RoomController.class);
         distanceSpinner.setModel(new SpinnerNumberModel(0, 0, 1000, roomController.getResolution())); 
         
     }
     
     private String getTypeName(String id) {
         return id.replaceAll("\\d+", "");
     }
     
     public void setSelectedId(String selectedId) {
         this.selectedId = selectedId;
         selectedElementLabel.setText(selectedId + " constraints");
         updateConstraintEditorFrame();
     }
 
     
     private void updateConstraintEditorFrame() {
         
        // This is done because to avoid aliasing
        relatableFurniture = new ArrayList(furnitureTypeController.getRoomFurniture());       
        relatableFurniture.remove(selectedId);
        
        unaryConstraintRadio.setSelected(true);
        updateComboBox(constraintTypeList, unaryConstraintController.getAvailableConstraints());
        
        updateActiveConstraintsList();
     }
     
     private void updateComboBox(JComboBox combo, Collection<? extends Object> constraintList) {
         combo.removeAllItems();
         for (Object item : constraintList)
             combo.addItem(item.toString());
     }
     
     private void updateComboBox(JComboBox combo, Object[] objects) {
         combo.removeAllItems();
         for (Object item : objects)
             combo.addItem(item.toString());
     }
     
     private void setListValues(JList jlist, Collection<? extends Object> objects) {
             jlist.setListData(objects.toArray(new Object[objects.size()]));
     }
     
     @Listen({ConstraintAddedEvent.class, ConstraintRemovedEvent.class})
    private void updateActiveConstraintsList() {
         Debug.println("Something changed");
         setListValues(activeUnaries, unaryConstraintController.getConstraints(selectedId));
         setListValues(activeBinaries, binaryConstraintController.getConstraints(selectedId));
         repaint();
     }
     
     /** This method is called from within the constructor to
      * initialize the form.
      * WARNING: Do NOT modify this code. The content of this method is
      * always regenerated by the Form Editor.
      */
     @SuppressWarnings("unchecked")
     // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
     private void initComponents() {
 
         jScrollPane1 = new javax.swing.JScrollPane();
         jTextArea1 = new javax.swing.JTextArea();
         constraintMultiplicity = new javax.swing.ButtonGroup();
         addConstraintButton = new javax.swing.JButton();
         cancelButton = new javax.swing.JButton();
         constraintTypeList = new javax.swing.JComboBox();
         unaryConstraintRadio = new javax.swing.JRadioButton();
         binaryConstraintRadio = new javax.swing.JRadioButton();
         selectedElementLabel = new javax.swing.JLabel();
         relatableCombo = new javax.swing.JComboBox();
         propertiesPanel = new javax.swing.JPanel();
         distanceSpinner = new javax.swing.JSpinner();
         distanceLabel = new javax.swing.JLabel();
         jScrollPanel2 = new javax.swing.JScrollPane();
         activeUnaries = new javax.swing.JList();
         jScrollPane2 = new javax.swing.JScrollPane();
         activeBinaries = new javax.swing.JList();
 
         jTextArea1.setColumns(20);
         jTextArea1.setRows(5);
         jScrollPane1.setViewportView(jTextArea1);
 
         setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
         setAlwaysOnTop(true);
         setName("Constraint Editor"); // NOI18N
         setResizable(false);
 
         addConstraintButton.setLabel("Add constraint");
         addConstraintButton.addActionListener(new java.awt.event.ActionListener() {
             public void actionPerformed(java.awt.event.ActionEvent evt) {
                 addConstraintButtonActionPerformed(evt);
             }
         });
 
         cancelButton.setText("Close");
         cancelButton.addActionListener(new java.awt.event.ActionListener() {
             public void actionPerformed(java.awt.event.ActionEvent evt) {
                 cancelButtonActionPerformed(evt);
             }
         });
 
         constraintTypeList.addActionListener(new java.awt.event.ActionListener() {
             public void actionPerformed(java.awt.event.ActionEvent evt) {
                 constraintTypeListActionPerformed(evt);
             }
         });
 
         constraintMultiplicity.add(unaryConstraintRadio);
         unaryConstraintRadio.setLabel("Unary");
         unaryConstraintRadio.addActionListener(new java.awt.event.ActionListener() {
             public void actionPerformed(java.awt.event.ActionEvent evt) {
                 unaryConstraintRadioActionPerformed(evt);
             }
         });
 
         constraintMultiplicity.add(binaryConstraintRadio);
         binaryConstraintRadio.setLabel("Binary");
         binaryConstraintRadio.addActionListener(new java.awt.event.ActionListener() {
             public void actionPerformed(java.awt.event.ActionEvent evt) {
                 binaryConstraintRadioActionPerformed(evt);
             }
         });
 
         selectedElementLabel.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
         selectedElementLabel.setAlignmentY(0.0F);
         selectedElementLabel.setFocusable(false);
         selectedElementLabel.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
 
         distanceLabel.setText("Distance:");
 
         javax.swing.GroupLayout propertiesPanelLayout = new javax.swing.GroupLayout(propertiesPanel);
         propertiesPanel.setLayout(propertiesPanelLayout);
         propertiesPanelLayout.setHorizontalGroup(
             propertiesPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
             .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, propertiesPanelLayout.createSequentialGroup()
                 .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                 .addComponent(distanceLabel)
                 .addGap(31, 31, 31)
                 .addComponent(distanceSpinner, javax.swing.GroupLayout.PREFERRED_SIZE, 48, javax.swing.GroupLayout.PREFERRED_SIZE)
                 .addGap(142, 142, 142))
         );
         propertiesPanelLayout.setVerticalGroup(
             propertiesPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
             .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, propertiesPanelLayout.createSequentialGroup()
                 .addContainerGap(24, Short.MAX_VALUE)
                 .addGroup(propertiesPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                     .addComponent(distanceSpinner, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                     .addComponent(distanceLabel))
                 .addContainerGap())
         );
 
         activeUnaries.setModel(new javax.swing.AbstractListModel() {
             String[] strings = {};
             public int getSize() { return strings.length; }
             public Object getElementAt(int i) { return strings[i]; }
         });
         activeUnaries.addKeyListener(new java.awt.event.KeyAdapter() {
             public void keyPressed(java.awt.event.KeyEvent evt) {
                 activeUnariesKeyPressed(evt);
             }
         });
         jScrollPanel2.setViewportView(activeUnaries);
 
         activeBinaries.setModel(new javax.swing.AbstractListModel() {
             String[] strings = {};
             public int getSize() { return strings.length; }
             public Object getElementAt(int i) { return strings[i]; }
         });
         activeBinaries.addKeyListener(new java.awt.event.KeyAdapter() {
             public void keyPressed(java.awt.event.KeyEvent evt) {
                 activeBinariesKeyPressed(evt);
             }
         });
         jScrollPane2.setViewportView(activeBinaries);
 
         javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
         getContentPane().setLayout(layout);
         layout.setHorizontalGroup(
             layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
             .addGroup(layout.createSequentialGroup()
                 .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                     .addGroup(layout.createSequentialGroup()
                         .addContainerGap()
                         .addComponent(selectedElementLabel, javax.swing.GroupLayout.DEFAULT_SIZE, 434, Short.MAX_VALUE))
                     .addGroup(layout.createSequentialGroup()
                         .addGap(29, 29, 29)
                         .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                             .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                                 .addComponent(propertiesPanel, javax.swing.GroupLayout.Alignment.TRAILING, 0, 158, Short.MAX_VALUE)
                                 .addComponent(relatableCombo, 0, 158, Short.MAX_VALUE)
                                 .addGroup(layout.createSequentialGroup()
                                     .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                                         .addComponent(unaryConstraintRadio)
                                         .addComponent(binaryConstraintRadio))
                                     .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED))
                                 .addComponent(constraintTypeList, 0, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                             .addComponent(addConstraintButton))
                         .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                             .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                                 .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                                 .addComponent(cancelButton)
                                 .addGap(62, 62, 62))
                             .addGroup(layout.createSequentialGroup()
                                 .addGap(55, 55, 55)
                                 .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                     .addComponent(jScrollPanel2, 0, 0, Short.MAX_VALUE)
                                     .addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 193, javax.swing.GroupLayout.PREFERRED_SIZE))))))
                 .addContainerGap())
         );
         layout.setVerticalGroup(
             layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
             .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                 .addContainerGap()
                 .addComponent(selectedElementLabel, javax.swing.GroupLayout.PREFERRED_SIZE, 21, javax.swing.GroupLayout.PREFERRED_SIZE)
                 .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING, false)
                     .addGroup(javax.swing.GroupLayout.Alignment.LEADING, layout.createSequentialGroup()
                         .addGap(2, 2, 2)
                         .addComponent(unaryConstraintRadio)
                         .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                         .addComponent(binaryConstraintRadio)
                         .addGap(18, 18, 18)
                         .addComponent(constraintTypeList, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                         .addGap(10, 10, 10)
                         .addComponent(relatableCombo, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                         .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                         .addComponent(propertiesPanel, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                     .addGroup(layout.createSequentialGroup()
                         .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                         .addComponent(jScrollPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, 96, javax.swing.GroupLayout.PREFERRED_SIZE)
                         .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                         .addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 91, javax.swing.GroupLayout.PREFERRED_SIZE)))
                 .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                 .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                     .addComponent(cancelButton)
                     .addComponent(addConstraintButton))
                 .addContainerGap())
         );
 
         pack();
     }// </editor-fold>//GEN-END:initComponents
 
 private void addConstraintButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_addConstraintButtonActionPerformed
     if (binaryConstraintRadio.isSelected()) {
         String otherId = (String) relatableCombo.getSelectedItem();
         String type = (String) constraintTypeList.getSelectedItem();
         int dist = (Integer) distanceSpinner.getValue();
         addBinaryConstraint(otherId, type, dist);
     }
     else if (unaryConstraintRadio.isSelected()) {
         String type = (String) constraintTypeList.getSelectedItem();
         String value = (String) relatableCombo.getSelectedItem();
         int numValue = (Integer) distanceSpinner.getValue();
         
         addUnaryConstraint(type, value, numValue);
         //wall;
         //depth; width; price;
         //position;
         
         
                
     }
     updateActiveConstraintsList();
 }//GEN-LAST:event_addConstraintButtonActionPerformed
 
 
 private void cancelButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cancelButtonActionPerformed
     dispose();
 }//GEN-LAST:event_cancelButtonActionPerformed
 
 private void constraintTypeListActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_constraintTypeListActionPerformed
     String consName = (String) constraintTypeList.getSelectedItem();
     if (consName != null &&  binaryConstraintRadio.isSelected() && consName.startsWith("dist")) {
         propertiesPanel.setVisible(true);
     }
     else {
         updateRelatableUnary();
     }
 }//GEN-LAST:event_constraintTypeListActionPerformed
 
 private void activeUnariesKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_activeUnariesKeyPressed
     int index = activeUnaries.getSelectedIndex();
     if (index >= 0) {
         UnaryConstraint constraint = (UnaryConstraint) activeUnaries.getModel().getElementAt(index);
         switch (evt.getKeyCode()) {
             case KeyEvent.VK_DELETE:  // press delete
                 unaryConstraintController.remove(selectedId, constraint.getClass());
                 break;            
         }
         updateActiveConstraintsList();
    }   
 }//GEN-LAST:event_activeUnariesKeyPressed
 
 private void activeBinariesKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_activeBinariesKeyPressed
     int index = activeBinaries.getSelectedIndex();
     if (index >= 0) {
         BinaryConstraintAssociation constraint = (BinaryConstraintAssociation) activeBinaries.getModel().getElementAt(index);
         switch (evt.getKeyCode()) {
             case KeyEvent.VK_DELETE:  // press delete
                 binaryConstraintController.removeConstraint(constraint.furniture1, constraint.furniture2,
                                                             constraint.getConstraint().getClass());
                 break;            
         }
         updateActiveConstraintsList();
    }
    
 }//GEN-LAST:event_activeBinariesKeyPressed
 
 private void binaryConstraintRadioActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_binaryConstraintRadioActionPerformed
     if (binaryConstraintRadio.isSelected()) {
         updateComboBox(constraintTypeList, binaryConstraintController.getAvailableConstraints());
         updateComboBox(relatableCombo, relatableFurniture);
         relatableCombo.setVisible(true);
     }
 }//GEN-LAST:event_binaryConstraintRadioActionPerformed
 
 private void unaryConstraintRadioActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_unaryConstraintRadioActionPerformed
     if (unaryConstraintRadio.isSelected()) {
         relatableCombo.setVisible(false);
         updateComboBox(constraintTypeList, unaryConstraintController.getAvailableConstraints());
         updateRelatableUnary();
     }
 }//GEN-LAST:event_unaryConstraintRadioActionPerformed
 
     /**
      * @param args the command line arguments
      */
     
     // Variables declaration - do not modify//GEN-BEGIN:variables
     private javax.swing.JList activeBinaries;
     private javax.swing.JList activeUnaries;
     private javax.swing.JButton addConstraintButton;
     private javax.swing.JRadioButton binaryConstraintRadio;
     private javax.swing.JButton cancelButton;
     private javax.swing.ButtonGroup constraintMultiplicity;
     private javax.swing.JComboBox constraintTypeList;
     private javax.swing.JLabel distanceLabel;
     private javax.swing.JSpinner distanceSpinner;
     private javax.swing.JScrollPane jScrollPane1;
     private javax.swing.JScrollPane jScrollPane2;
     private javax.swing.JScrollPane jScrollPanel2;
     private javax.swing.JTextArea jTextArea1;
     private javax.swing.JPanel propertiesPanel;
     private javax.swing.JComboBox relatableCombo;
     private javax.swing.JLabel selectedElementLabel;
     private javax.swing.JRadioButton unaryConstraintRadio;
     // End of variables declaration//GEN-END:variables
 
 
     private void addBinaryConstraint(String otherId, String type, int dist) {
         if (type.equals("distance-max"))
             binaryConstraintController.addMaxDistanceConstraint(selectedId, otherId, dist);
         else if (type.equals("distance-min"))
             binaryConstraintController.addMinDistanceConstraint(selectedId, otherId, dist);
         else if (type.equals("facing-straight"))
             binaryConstraintController.addStraightFacingConstraint(selectedId, otherId);
         else if (type.equals("facing-partial"))
             binaryConstraintController.addPartialFacingConstraint(selectedId, otherId);
     }
 
     private void addUnaryConstraint(String type, String value, int numValue) {
         if (type.equals("color")) {
             unaryConstraintController.addColorConstraint(selectedId, value);
         }
         else if (type.equals("model")) {
             unaryConstraintController.addModelConstraint(selectedId, value);
         }
         else if (type.equals("orientation")) {
             unaryConstraintController.addOrientationConstraint(selectedId, value);              
         }
         else if (type.equals("material")) {
             unaryConstraintController.addMaterialConstraint(selectedId, value);
         }
     }
     
     private void updateRelatableUnary() {
         String type = (String) constraintTypeList.getSelectedItem();
         if (type != null) {
             String typeName = getTypeName(selectedId);
             if (type.equals("color")) {
                 updateComboBox(relatableCombo, CoolColor.getNames());
                 relatableCombo.setVisible(true);
                 propertiesPanel.setVisible(false);
             }
             else if (type.equals("model")) {
                 updateComboBox(relatableCombo, furnitureModelController.getFurnitureModelNames(typeName));
                 relatableCombo.setVisible(true);
                 propertiesPanel.setVisible(false);
             }
             else if (type.equals("orientation")) {
                 updateComboBox(relatableCombo, Orientation.values());
                 relatableCombo.setVisible(true);
                 propertiesPanel.setVisible(false);                
             }
             else if (type.equals("material")) {
                 updateComboBox(relatableCombo, Material.values());
                 relatableCombo.setVisible(true);
                 propertiesPanel.setVisible(false);
             }
         }
     }
 
 }
