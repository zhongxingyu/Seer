 package edu.northwestern.bioinformatics.studycalendar.utils.accesscontrol;
 
 import edu.northwestern.bioinformatics.studycalendar.domain.Fixtures;
 import edu.northwestern.bioinformatics.studycalendar.domain.User;
 import edu.northwestern.bioinformatics.studycalendar.domain.UserRole;
 import edu.northwestern.bioinformatics.studycalendar.domain.Role;
 import edu.northwestern.bioinformatics.studycalendar.domain.Study;
 import edu.northwestern.bioinformatics.studycalendar.domain.Site;
 import edu.northwestern.bioinformatics.studycalendar.testing.StudyCalendarTestCase;
 import gov.nih.nci.security.UserProvisioningManager;
 import gov.nih.nci.security.authorization.domainobjects.Group;
 import gov.nih.nci.security.authorization.domainobjects.ProtectionElement;
 import gov.nih.nci.security.authorization.domainobjects.ProtectionGroup;
 import gov.nih.nci.security.dao.GroupSearchCriteria;
 import gov.nih.nci.security.dao.RoleSearchCriteria;
 import gov.nih.nci.security.exceptions.CSObjectNotFoundException;
 import org.easymock.IArgumentMatcher;
 import org.easymock.classextension.EasyMock;
 import static org.easymock.classextension.EasyMock.*;
 
 import java.util.ArrayList;
 import static java.util.Arrays.asList;
 import java.util.LinkedHashSet;
 import java.util.List;
 import java.util.Set;
 
 /**
  * @author Rhett Sutphin
  */
 public class StudyCalendarAuthorizationManagerTest extends StudyCalendarTestCase {
     private static final String URL = "/zip/zip/zip";
     private static final ProtectionGroup
         PG1 = createPG(1), PG2 = createPG(2), PG3 = createPG(3);
 
     private StudyCalendarAuthorizationManager manager;
     private UserProvisioningManager userProvisioningManager;
 
     private User user;
     private Study studyA, studyB, studyAB;
     private Site siteA, siteB;
 
     protected void setUp() throws Exception {
         super.setUp();
         userProvisioningManager = registerMockFor(UserProvisioningManager.class);
 
         expect(userProvisioningManager.getProtectionGroups()).andReturn(pgList(PG1, PG2, PG3)).anyTimes();
 
         manager = new StudyCalendarAuthorizationManager();
         manager.setUserProvisioningManager(userProvisioningManager);
 
         user = Fixtures.createUser("jimbo");
 
         studyA = Fixtures.createNamedInstance("A", Study.class);
         studyB = Fixtures.createNamedInstance("B", Study.class);
         studyAB = Fixtures.createNamedInstance("AB", Study.class);
         siteA = Fixtures.createNamedInstance("a", Site.class);
         siteB = Fixtures.createNamedInstance("b", Site.class);
         studyA.addSite(siteA);
         studyB.addSite(siteB);
         studyAB.addSite(siteA);
         studyAB.addSite(siteB);
     }
 
     public void testRegisterUrlWhenNew() throws Exception {
         userProvisioningManager.getProtectionElement(URL);
         expectLastCall().andThrow(new CSObjectNotFoundException("No such thing"));
 
         ProtectionElement expectedPE = new ProtectionElement();
         expectedPE.setObjectId(URL);
         expectedPE.setProtectionElementName(URL);
         expectedPE.setProtectionElementDescription("Autogenerated PE for " + URL);
         userProvisioningManager.createProtectionElement(matchByProperties(expectedPE));
         expectedPE.setProtectionElementId(56L);
         expect(userProvisioningManager.getProtectionElement(URL)).andReturn(expectedPE);
         expect(userProvisioningManager.getProtectionGroups("56")).andReturn(pgSet());
 
         userProvisioningManager.assignToProtectionGroups(eq("56"), aryEq(pgIds(PG1)));
 
         replayMocks();
         manager.registerUrl(URL, pgNames(PG1));
         verifyMocks();
     }
 
     public void testRegisterUrlWhenCorrect() throws Exception {
         ProtectionElement expectedPE = new ProtectionElement();
         expectedPE.setProtectionElementId(345L);
         expectedPE.setObjectId(URL);
         expect(userProvisioningManager.getProtectionElement(URL)).andReturn(expectedPE);
         expect(userProvisioningManager.getProtectionGroups("345")).andReturn(pgSet(PG2));
 
         replayMocks();
         manager.registerUrl(URL, pgNames(PG2));
         verifyMocks();
     }
 
     public void testRegisterUrlWhenGroupsChanged() throws Exception {
         ProtectionElement expectedCurrentPE = new ProtectionElement();
         expectedCurrentPE.setObjectId(URL);
         expectedCurrentPE.setProtectionElementId(456L);
         expect(userProvisioningManager.getProtectionElement(URL)).andReturn(expectedCurrentPE);
         expect(userProvisioningManager.getProtectionGroups("456")).andReturn(pgSet(PG1, PG2));
 
         userProvisioningManager.assignToProtectionGroups(eq("456"), aryEq(pgIds(PG1, PG3)));
 
         replayMocks();
         manager.registerUrl(URL, pgNames(PG1, PG3));
         verifyMocks();
     }
 
     public void testAssignProtectionGroupsToUsers() throws Exception {
         gov.nih.nci.security.authorization.domainobjects.Role role0 = new gov.nih.nci.security.authorization.domainobjects.Role();
         role0.setName(Role.SITE_COORDINATOR.csmRole());
         role0.setId(7L);
         gov.nih.nci.security.authorization.domainobjects.Role role1 = new gov.nih.nci.security.authorization.domainobjects.Role();
         role1.setName(Role.SUBJECT_COORDINATOR.csmRole());
         role1.setId(4L);
 
         String userId = "1";
 
         ProtectionGroup protectionGroup = new ProtectionGroup();
         protectionGroup.setProtectionGroupId(100L);
 
         RoleSearchCriteria criteria0 = new RoleSearchCriteria(role0);
         RoleSearchCriteria criteria1 = new RoleSearchCriteria(role1);
 
         expect(userProvisioningManager.getObjects(eqRoleSearchCriteria(criteria0))).andReturn(asList(role0));
         expect(userProvisioningManager.getObjects(eqRoleSearchCriteria(criteria1))).andReturn(asList(role1));
 
         userProvisioningManager.assignUserRoleToProtectionGroup(eq(userId), aryEq(new String[]{role0.getId().toString(), role1.getId().toString()}), eq(protectionGroup.getProtectionGroupId().toString()));
         replayMocks();
 
         manager.assignProtectionGroupsToUsers(asList(userId), protectionGroup, new String[] {role0.getName(), role1.getName()});
         verifyMocks();
     }
 
     public void testStudyVisibilityForSubjectCoordinator() throws Exception {
         UserRole coord = Fixtures.createUserRole(user, Role.SUBJECT_COORDINATOR, siteB);
         coord.addStudySite(studyAB.getStudySite(siteB));
         assertFalse(manager.isTemplateVisible(coord, studyA));
         assertFalse(manager.isTemplateVisible(coord, studyB));
         assertTrue(manager.isTemplateVisible(coord, studyAB));
     }
 
     public void testStudyVisibilityForResearchAssociate() throws Exception {
         UserRole coord = Fixtures.createUserRole(user, Role.RESEARCH_ASSOCIATE, siteA);
         coord.addStudySite(studyA.getStudySite(siteA));
         assertTrue(manager.isTemplateVisible(coord, studyA));
         assertFalse(manager.isTemplateVisible(coord, studyB));
         assertFalse(manager.isTemplateVisible(coord, studyAB));
     }
 
     public void testStudyVisibilityForSiteCoordinator() throws Exception {
         UserRole coord = Fixtures.createUserRole(user, Role.SITE_COORDINATOR, siteA);
         assertTrue(manager.isTemplateVisible(coord, studyA));
         assertFalse(manager.isTemplateVisible(coord, studyB));
         assertTrue(manager.isTemplateVisible(coord, studyAB));
     }
 
     public void testStudyVisibilityForSystemAdministrator() throws Exception {
         UserRole admin = Fixtures.createUserRole(user, Role.SYSTEM_ADMINISTRATOR, siteA);
         assertFalse(manager.isTemplateVisible(admin, studyA));
         assertFalse(manager.isTemplateVisible(admin, studyB));
         assertFalse(manager.isTemplateVisible(admin, studyAB));
     }
 
     public void testStudyVisibilityForStudyAdministrator() throws Exception {
         UserRole admin = Fixtures.createUserRole(user, Role.STUDY_ADMIN);
         assertTrue(manager.isTemplateVisible(admin, studyA));
         assertTrue(manager.isTemplateVisible(admin, studyB));
         assertTrue(manager.isTemplateVisible(admin, studyAB));
     }
 
     public void testStudyVisibilityForStudyCoordinator() throws Exception {
        UserRole coord = Fixtures.createUserRole(user, Role.STUDY_COORDINATOR);
         assertTrue(manager.isTemplateVisible(coord, studyA));
         assertTrue(manager.isTemplateVisible(coord, studyB));
         assertTrue(manager.isTemplateVisible(coord, studyAB));
     }
 
     public void testIsGroupEqualToRole() {
         StudyCalendarAuthorizationManager us = new StudyCalendarAuthorizationManager();
         assertTrue(us.isGroupEqualToRole(createCsmGroup(1L, "STUDY_COORDINATOR"), Role.STUDY_COORDINATOR));
         assertFalse(us.isGroupEqualToRole(createCsmGroup(1L, "STUDY_COORDINATOR"), Role.SITE_COORDINATOR));
     }
 
     private static ProtectionGroup createPG(long id) {
         ProtectionGroup g = new ProtectionGroup();
         g.setProtectionGroupId(id);
         g.setProtectionGroupName("PG" + id);
         return g;
     }
 
     private static List<ProtectionGroup> pgList(ProtectionGroup... groups) {
         return asList(groups);
     }
 
     private static Set<ProtectionGroup> pgSet(ProtectionGroup... groups) {
         return new LinkedHashSet<ProtectionGroup>(pgList(groups));
     }
 
     private static List<String> pgNames(ProtectionGroup... groups) {
         List<String> names = new ArrayList<String>(groups.length);
         for (ProtectionGroup group : groups) names.add(group.getProtectionGroupName());
         return names;
     }
 
     private static String[] pgIds(ProtectionGroup... groups) {
         List<String> ids = new ArrayList<String>(groups.length);
         for (ProtectionGroup group : groups) ids.add(group.getProtectionGroupId().toString());
         return ids.toArray(new String[0]);
     }
 
     public static RoleSearchCriteria eqRoleSearchCriteria(RoleSearchCriteria in) {
         EasyMock.reportMatcher(new RoleSearchCriteriaEquals(in));
         return null;
     }
 
     public static class RoleSearchCriteriaEquals implements IArgumentMatcher {
         private RoleSearchCriteria expected;
 
         public RoleSearchCriteriaEquals(RoleSearchCriteria expected) {
             this.expected = expected;
         }
 
         public boolean matches(Object actual) {
             if (!(actual instanceof RoleSearchCriteria)) {
                 return false;
             }
 
             return(((RoleSearchCriteria) actual).getFieldAndValues().entrySet().iterator().next()
                     .equals((expected.getFieldAndValues().entrySet().iterator().next())));
         }
 
         public void appendTo(StringBuffer buffer) {
             buffer.append("eqRoleSearchCriteria(");
             buffer.append(expected.getClass().getName());
             buffer.append(" with message \"");
             buffer.append(expected.getFieldAndValues().entrySet().iterator().next());
             buffer.append("\")");
         }
     }
 
      public static GroupSearchCriteria eqGroupSearchCriteria(GroupSearchCriteria in) {
         EasyMock.reportMatcher(new GroupSearchCriteriaEquals(in));
         return null;
     }
 
     public static class GroupSearchCriteriaEquals implements IArgumentMatcher {
         private GroupSearchCriteria expected;
 
         public GroupSearchCriteriaEquals(GroupSearchCriteria expected) {
             this.expected = expected;
         }
 
         public boolean matches(Object actual) {
             if (!(actual instanceof GroupSearchCriteria)) {
                 return false;
             }
 
             return(((GroupSearchCriteria) actual).getFieldAndValues().entrySet().iterator().next()
                     .equals((expected.getFieldAndValues().entrySet().iterator().next())));
         }
 
         public void appendTo(StringBuffer buffer) {
             buffer.append("eqRoleSearchCriteria(");
             buffer.append(expected.getClass().getName());
             buffer.append(" with message \"");
             buffer.append(expected.getFieldAndValues().entrySet().iterator().next());
             buffer.append("\")");
         }
     }
 
 
     private Group createCsmGroup(Long id, String name) {
         Group g = new Group();
         g.setGroupId(id);
         g.setGroupName(name);
         return g;
     }    
 }
