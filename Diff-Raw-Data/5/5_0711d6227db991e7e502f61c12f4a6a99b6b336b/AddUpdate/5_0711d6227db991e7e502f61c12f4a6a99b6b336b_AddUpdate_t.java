 package my.triviagame.gui;
 
 import java.util.ArrayList;
 import java.util.List;
 import java.util.logging.Level;
 import java.util.logging.Logger;
 import javax.swing.JOptionPane;
 import javax.swing.ListSelectionModel;
 import javax.swing.table.DefaultTableModel;
 import my.triviagame.bll.Database;
 import my.triviagame.dal.*;
 
 public class AddUpdate extends javax.swing.JDialog {
 
     private IAlbumDescriptor albumDesc = null;
     private List<ITrackDescriptor> trackDescriptors = null;
     private boolean isNewAlbum;
     private Discover discoverForm;
     
     /**
      * Creates new form AddUpdate
      */
     public AddUpdate(java.awt.Frame parent, boolean modal, Discover discoverForm, IAlbumDescriptor albumDesc, List<ITrackDescriptor> trackDescriptors) {
         super(parent, modal);
         initComponents();
         setLocationRelativeTo(null);
         this.discoverForm = discoverForm;
         this.isNewAlbum = (discoverForm == null) ? true : false;
         if (!isNewAlbum)
         {
             this.jButton2.setEnabled(true);
             this.albumDesc = albumDesc;
             this.trackDescriptors = trackDescriptors;
         }
         initFields();
         this.getRootPane().setDefaultButton(this.jButton1);
         jTableTracks.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
     }
 
     private void initFields()
     {
         if (albumDesc != null)
         {
             jTextFieldTitle.setText(albumDesc.getTitle());
             jTextFieldArtist.setText(albumDesc.getArtistName());
             jTextFieldFreeDbId.setText(String.format("0x%X", albumDesc.getFreedbId()));
             jTextFieldGenre.setText(albumDesc.getGenre());
             jTextFieldYear.setText(String.valueOf(albumDesc.getYear()));
         }
         
         ((DefaultTableModel)jTableTracks.getModel()).setRowCount(0);
 
         if (trackDescriptors != null)
         {
             for (int i = 0; i < trackDescriptors.size(); i++)
             {
                 ITrackDescriptor trackDesc = trackDescriptors.get(i);
                 int s =trackDesc.getLengthInSeconds();
                 String[] currTrackData = new String[] {
                     trackDesc.getTitle(),
                     trackDesc.getArtistName(),
                     String.format("%02d:%02d:%02d", s/3600, (s%3600)/60, (s%60))};
             ((DefaultTableModel)jTableTracks.getModel()).addRow(currTrackData);            }
         }
     }
     
     /**
      * This method is called from within the constructor to initialize the form.
      * WARNING: Do NOT modify this code. The content of this method is always
      * regenerated by the Form Editor.
      */
     @SuppressWarnings("unchecked")
     // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
     private void initComponents() {
 
         jPanel1 = new javax.swing.JPanel();
         jLabel1 = new javax.swing.JLabel();
         jLabel2 = new javax.swing.JLabel();
         jLabel3 = new javax.swing.JLabel();
         jLabel4 = new javax.swing.JLabel();
         jTextFieldArtist = new javax.swing.JTextField();
         jTextFieldGenre = new javax.swing.JTextField();
         jTextFieldYear = new javax.swing.JTextField();
         jTextFieldFreeDbId = new javax.swing.JTextField();
         jLabel5 = new javax.swing.JLabel();
         jScrollPane1 = new javax.swing.JScrollPane();
         jTableTracks = new javax.swing.JTable();
         jButton1 = new javax.swing.JButton();
         jButton2 = new javax.swing.JButton();
         jTextFieldTitle = new javax.swing.JTextField();
         jLabel6 = new javax.swing.JLabel();
         jButton3 = new javax.swing.JButton();
         jButton4 = new javax.swing.JButton();
         jButton5 = new javax.swing.JButton();
 
         setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
         setResizable(false);
 
         jPanel1.setBackground(new java.awt.Color(255, 255, 255));
 
         jLabel1.setText("Artist:");
 
         jLabel2.setText("Genre:");
 
         jLabel3.setText("Year:");
 
         jLabel4.setText("FreeDb Id:");
 
         jTextFieldFreeDbId.setEditable(false);
 
         jLabel5.setText("Tracks");
 
         jTableTracks.setModel(new javax.swing.table.DefaultTableModel(
             new Object [][] {
 
             },
             new String [] {
                 "Title", "Artist", "Length"
             }
         ) {
             Class[] types = new Class [] {
                 java.lang.String.class, java.lang.String.class, java.lang.String.class
             };
 
             public Class getColumnClass(int columnIndex) {
                 return types [columnIndex];
             }
         });
         jScrollPane1.setViewportView(jTableTracks);
 
         jButton1.setText("Save");
         jButton1.addActionListener(new java.awt.event.ActionListener() {
             public void actionPerformed(java.awt.event.ActionEvent evt) {
                 jButton1ActionPerformed(evt);
             }
         });
 
         jButton2.setText("Delete");
         jButton2.setToolTipText("");
         jButton2.setEnabled(false);
         jButton2.addActionListener(new java.awt.event.ActionListener() {
             public void actionPerformed(java.awt.event.ActionEvent evt) {
                 jButton2ActionPerformed(evt);
             }
         });
 
         jLabel6.setText("Title:");
 
         jButton3.setText("Discard");
         jButton3.addActionListener(new java.awt.event.ActionListener() {
             public void actionPerformed(java.awt.event.ActionEvent evt) {
                 onDiscard(evt);
             }
         });
 
         jButton4.setText("Add New Track");
         jButton4.addActionListener(new java.awt.event.ActionListener() {
             public void actionPerformed(java.awt.event.ActionEvent evt) {
                 jButton4ActionPerformed(evt);
             }
         });
 
         jButton5.setText("Delete Track");
         jButton5.addActionListener(new java.awt.event.ActionListener() {
             public void actionPerformed(java.awt.event.ActionEvent evt) {
                 jButton5ActionPerformed(evt);
             }
         });
 
         javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
         jPanel1.setLayout(jPanel1Layout);
         jPanel1Layout.setHorizontalGroup(
             jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
             .addGroup(jPanel1Layout.createSequentialGroup()
                 .addContainerGap()
                 .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                     .addComponent(jButton1, javax.swing.GroupLayout.PREFERRED_SIZE, 84, javax.swing.GroupLayout.PREFERRED_SIZE)
                     .addGroup(jPanel1Layout.createSequentialGroup()
                         .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                             .addComponent(jLabel1)
                             .addComponent(jLabel2)
                             .addComponent(jLabel3)
                             .addComponent(jLabel4)
                             .addComponent(jLabel6))
                         .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                         .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING, false)
                             .addComponent(jTextFieldGenre, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, 384, Short.MAX_VALUE)
                             .addComponent(jTextFieldYear, javax.swing.GroupLayout.Alignment.LEADING)
                             .addComponent(jTextFieldFreeDbId, javax.swing.GroupLayout.Alignment.LEADING)
                             .addComponent(jTextFieldArtist)
                             .addComponent(jTextFieldTitle))))
                 .addGap(18, 18, 18)
                 .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                     .addGroup(jPanel1Layout.createSequentialGroup()
                         .addComponent(jButton2, javax.swing.GroupLayout.PREFERRED_SIZE, 84, javax.swing.GroupLayout.PREFERRED_SIZE)
                         .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                         .addComponent(jButton3, javax.swing.GroupLayout.PREFERRED_SIZE, 83, javax.swing.GroupLayout.PREFERRED_SIZE)
                         .addContainerGap())
                     .addGroup(jPanel1Layout.createSequentialGroup()
                         .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                             .addGroup(jPanel1Layout.createSequentialGroup()
                                 .addGap(0, 0, Short.MAX_VALUE)
                                 .addComponent(jButton4)
                                 .addGap(18, 18, 18)
                                 .addComponent(jButton5, javax.swing.GroupLayout.PREFERRED_SIZE, 116, javax.swing.GroupLayout.PREFERRED_SIZE))
                             .addGroup(javax.swing.GroupLayout.Alignment.LEADING, jPanel1Layout.createSequentialGroup()
                                 .addComponent(jLabel5)
                                 .addGap(0, 0, Short.MAX_VALUE))
                             .addComponent(jScrollPane1, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, 470, Short.MAX_VALUE))
                         .addContainerGap(56, Short.MAX_VALUE))))
         );
         jPanel1Layout.setVerticalGroup(
             jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
             .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel1Layout.createSequentialGroup()
                 .addContainerGap()
                 .addComponent(jLabel5)
                 .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                 .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                     .addGroup(jPanel1Layout.createSequentialGroup()
                         .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                             .addComponent(jTextFieldArtist, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                             .addComponent(jLabel1))
                         .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                         .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                             .addComponent(jTextFieldTitle, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                             .addComponent(jLabel6))
                         .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                         .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                             .addComponent(jTextFieldGenre, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                             .addComponent(jLabel2))
                         .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                         .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                             .addComponent(jTextFieldYear, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                             .addComponent(jLabel3))
                         .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                         .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                             .addComponent(jTextFieldFreeDbId, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                             .addComponent(jLabel4)))
                     .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 336, javax.swing.GroupLayout.PREFERRED_SIZE))
                 .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                 .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                     .addComponent(jButton5)
                     .addComponent(jButton4))
                 .addGap(21, 21, 21)
                 .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.CENTER)
                     .addComponent(jButton1, javax.swing.GroupLayout.DEFAULT_SIZE, 33, Short.MAX_VALUE)
                     .addComponent(jButton2, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                     .addComponent(jButton3, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                 .addContainerGap())
         );
 
         javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
         getContentPane().setLayout(layout);
         layout.setHorizontalGroup(
             layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
             .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
         );
         layout.setVerticalGroup(
             layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
             .addGroup(layout.createSequentialGroup()
                 .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                 .addGap(0, 0, Short.MAX_VALUE))
         );
 
         pack();
     }// </editor-fold>//GEN-END:initComponents
 
     private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
         if (jTextFieldArtist.getText().isEmpty())
         {
             JOptionPane.showMessageDialog(this, "An album must have an artist.");
             return;
         }
 
         if  (jTextFieldTitle.getText().isEmpty())
         {
             JOptionPane.showMessageDialog(this, "An album must have a title.");
             return;
         }
 
         if  (jTextFieldGenre.getText().isEmpty())
         {
             JOptionPane.showMessageDialog(this, "An album must have a genre.");
             return;
         }
         
         
         if (jTextFieldYear.getText().isEmpty())
         {
             JOptionPane.showMessageDialog(this, "An album must have a year.");
             return;
         }
         
         try
         {
             Short.parseShort(jTextFieldYear.getText());
         }
         catch (Exception ex)
         {
             JOptionPane.showMessageDialog(this, "Album year is in an invalid format.");
             return;
         }
 
         DefaultTableModel model = (DefaultTableModel)jTableTracks.getModel();
         if (model.getRowCount() == 0)
         {
             JOptionPane.showMessageDialog(this, "An album must have at least one track.");
             return;
         }
 
         for (int i = 0; i < model.getRowCount(); i++)
         {
             String trackLength = model.getValueAt(i, 2).toString();
             try
             {
                 GuiUtils.convertTimeStringToSeconds(trackLength);
             }
             catch (Exception ex)
             {
                 JOptionPane.showMessageDialog(this, "Track number " + (i + 1) + " contains an invalid length.");
                 ListSelectionModel selectionModel = jTableTracks.getSelectionModel();
                 selectionModel.setSelectionInterval(i, i);
                 return;
             }
         }
 
         Save();
     }//GEN-LAST:event_jButton1ActionPerformed
 
     private void jButton2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton2ActionPerformed
         int answer = JOptionPane.showConfirmDialog(rootPane, "Are you sure you want to delete this album?\r\nThis action cannot be undone.", "Delete", JOptionPane.YES_NO_OPTION);
         if (answer != JOptionPane.YES_OPTION)
         {
             return;
         }
         Delete();
     }//GEN-LAST:event_jButton2ActionPerformed
 
     private void onDiscard(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_onDiscard
         dispose();
     }//GEN-LAST:event_onDiscard
 
     private void jButton4ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton4ActionPerformed
         DefaultTableModel model = (DefaultTableModel)jTableTracks.getModel();
         String[] newRow = new String[]{"Title", "Artist", "00:01:00"};
         model.addRow(newRow);
         ListSelectionModel selectionModel = jTableTracks.getSelectionModel();
         selectionModel.setSelectionInterval(model.getRowCount() - 1, model.getRowCount() - 1);
     }//GEN-LAST:event_jButton4ActionPerformed
 
     private void jButton5ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton5ActionPerformed
         ListSelectionModel selectionModel = jTableTracks.getSelectionModel();
         int selectedRowIndex = selectionModel.getMinSelectionIndex();
         if (selectedRowIndex == -1)
         {
             JOptionPane.showMessageDialog(this, "Please select a track to remove.");
             return;
         }
         DefaultTableModel model = (DefaultTableModel)jTableTracks.getModel();
         model.removeRow(selectedRowIndex);
     }//GEN-LAST:event_jButton5ActionPerformed
 
     private void Delete()
     {
         IDAL dataAccessLayer = Database.getDataAccessLayer();
         try {
             dataAccessLayer.deleteAlbum(albumDesc);
         } catch (DALException ex) {
             JOptionPane.showMessageDialog(this, "Error deleting album.\r\nCheck log file for more details.");
             Logger.getLogger(AddUpdate.class.getName()).log(Level.SEVERE, null, ex);
             return;
         }
         
         JOptionPane.showMessageDialog(this, "Album deleted successfully.");
        if (discoverForm != null)
        {
            discoverForm.refreshSearch();
        }
         this.dispose();
     }
     
     private void Save()
     {
         IDAL dataAccessLayer = Database.getDataAccessLayer();
 
         String albumGenre = jTextFieldGenre.getText();
         String albumTitle = jTextFieldTitle.getText();
         String albumArtistName = jTextFieldArtist.getText();
         Short albumYear = Short.parseShort(jTextFieldYear.getText());
 
         IAlbumDescriptor albumToSave;
         if (isNewAlbum)
         {
             albumToSave = AlbumDescriptor.createNewAlbum(albumGenre, albumTitle, albumArtistName, albumYear);
         }
         else
         {
             albumToSave = AlbumDescriptor.createUpdatedAlbum(albumDesc, albumTitle, albumArtistName, albumGenre, albumYear);
         }
 
         List<ITrackDescriptor> trackList = new ArrayList<ITrackDescriptor>();
         DefaultTableModel model = (DefaultTableModel)jTableTracks.getModel();
         for (int i = 0; i < ((DefaultTableModel)jTableTracks.getModel()).getRowCount(); i++)
         {
             String title = model.getValueAt(i, 0).toString();
             String artistName = model.getValueAt(i, 1).toString();
             short lengthInSeconds = GuiUtils.convertTimeStringToSeconds(model.getValueAt(i, 2).toString());
             byte trackNum = (byte) (i + 1);
             ITrackDescriptor track = TrackDescriptor.createNewTrack(title, trackNum, lengthInSeconds, artistName);
             trackList.add(track);
         }
         try {
             dataAccessLayer.updateAlbum(albumToSave, trackList);
         } catch (DALException ex) {
             Logger.getLogger(AddUpdate.class.getName()).log(Level.SEVERE, null, ex);
             if (isNewAlbum)
             {
                 JOptionPane.showMessageDialog(this, "Error adding new album to db.\r\nSee log file for more details.");
             }
             else
             {
                 JOptionPane.showMessageDialog(this, "Error updating album in db.\r\nSee log file for more details.");
             }
             return;
         }
         JOptionPane.showMessageDialog(this, "Saved successfully.");
         discoverForm.refreshSearch();
         this.dispose();
     }
     /**
      * @param args the command line arguments
      */
     public static void main(String args[]) {
         /*
          * Set the Nimbus look and feel
          */
         //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
         /*
          * If Nimbus (introduced in Java SE 6) is not available, stay with the
          * default look and feel. For details see
          * http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html
          */
         try {
             for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                 if ("Nimbus".equals(info.getName())) {
                     javax.swing.UIManager.setLookAndFeel(info.getClassName());
                     break;
                 }
             }
         } catch (ClassNotFoundException ex) {
             java.util.logging.Logger.getLogger(AddUpdate.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
         } catch (InstantiationException ex) {
             java.util.logging.Logger.getLogger(AddUpdate.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
         } catch (IllegalAccessException ex) {
             java.util.logging.Logger.getLogger(AddUpdate.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
         } catch (javax.swing.UnsupportedLookAndFeelException ex) {
             java.util.logging.Logger.getLogger(AddUpdate.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
         }
         //</editor-fold>
 
         /*
          * Create and display the form
          */
         java.awt.EventQueue.invokeLater(new Runnable() {
 
             public void run() {
             }
         });
     }
     // Variables declaration - do not modify//GEN-BEGIN:variables
     private javax.swing.JButton jButton1;
     private javax.swing.JButton jButton2;
     private javax.swing.JButton jButton3;
     private javax.swing.JButton jButton4;
     private javax.swing.JButton jButton5;
     private javax.swing.JLabel jLabel1;
     private javax.swing.JLabel jLabel2;
     private javax.swing.JLabel jLabel3;
     private javax.swing.JLabel jLabel4;
     private javax.swing.JLabel jLabel5;
     private javax.swing.JLabel jLabel6;
     private javax.swing.JPanel jPanel1;
     private javax.swing.JScrollPane jScrollPane1;
     private javax.swing.JTable jTableTracks;
     private javax.swing.JTextField jTextFieldArtist;
     private javax.swing.JTextField jTextFieldFreeDbId;
     private javax.swing.JTextField jTextFieldGenre;
     private javax.swing.JTextField jTextFieldTitle;
     private javax.swing.JTextField jTextFieldYear;
     // End of variables declaration//GEN-END:variables
 }
