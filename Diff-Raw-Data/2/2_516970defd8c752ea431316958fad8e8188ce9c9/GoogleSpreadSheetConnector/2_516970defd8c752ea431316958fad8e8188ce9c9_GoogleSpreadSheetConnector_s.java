 /**
  * Mule Google Spreadsheets Cloud Connector
  *
  * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com
  *
  * The software in this package is published under the terms of the CPAL v1.0
  * license, a copy of which has been included with this distribution in the
  * LICENSE.txt file.
  */
 
 /**
  * This file was automatically generated by the Mule Development Kit
  */
 package org.mule.module.google.spreadsheet;
 
 import java.io.IOException;
 import java.net.URL;
 import java.util.List;
 
 import org.apache.commons.lang.StringUtils;
 import org.apache.log4j.Logger;
 import org.mule.api.annotations.Configurable;
 import org.mule.api.annotations.Connector;
 import org.mule.api.annotations.Processor;
 import org.mule.api.annotations.oauth.OAuth2;
 import org.mule.api.annotations.oauth.OAuthAccessToken;
 import org.mule.api.annotations.oauth.OAuthAuthorizationParameter;
 import org.mule.api.annotations.oauth.OAuthConsumerKey;
 import org.mule.api.annotations.oauth.OAuthConsumerSecret;
 import org.mule.api.annotations.oauth.OAuthInvalidateAccessTokenOn;
 import org.mule.api.annotations.oauth.OAuthPostAuthorization;
 import org.mule.api.annotations.oauth.OAuthProtected;
 import org.mule.api.annotations.oauth.OAuthScope;
 import org.mule.api.annotations.param.Default;
 import org.mule.api.annotations.param.Optional;
 import org.mule.module.google.spreadsheet.model.Cell;
 import org.mule.module.google.spreadsheet.model.ModelParser;
 import org.mule.module.google.spreadsheet.model.Row;
 import org.mule.module.google.spreadsheet.model.Spreadsheet;
 import org.mule.module.google.spreadsheet.model.Worksheet;
 import org.mule.modules.google.AbstractGoogleOAuthConnector;
 import org.mule.modules.google.AccessType;
 import org.mule.modules.google.ForcePrompt;
 import org.mule.modules.google.oauth.invalidation.InvalidationAwareCredential;
 import org.mule.modules.google.oauth.invalidation.OAuthTokenExpiredException;
 
 import com.google.api.client.auth.oauth2.BearerToken;
 import com.google.api.client.auth.oauth2.Credential;
 import com.google.gdata.client.authn.oauth.OAuthException;
 import com.google.gdata.client.docs.DocsService;
 import com.google.gdata.client.spreadsheet.CellQuery;
 import com.google.gdata.client.spreadsheet.FeedURLFactory;
 import com.google.gdata.client.spreadsheet.SpreadsheetQuery;
 import com.google.gdata.client.spreadsheet.SpreadsheetService;
 import com.google.gdata.client.spreadsheet.WorksheetQuery;
 import com.google.gdata.data.Link;
 import com.google.gdata.data.Person;
 import com.google.gdata.data.PlainTextConstruct;
 import com.google.gdata.data.batch.BatchOperationType;
 import com.google.gdata.data.batch.BatchUtils;
 import com.google.gdata.data.spreadsheet.CellEntry;
 import com.google.gdata.data.spreadsheet.CellFeed;
 import com.google.gdata.data.spreadsheet.SpreadsheetEntry;
 import com.google.gdata.data.spreadsheet.SpreadsheetFeed;
 import com.google.gdata.data.spreadsheet.WorksheetEntry;
 import com.google.gdata.data.spreadsheet.WorksheetFeed;
 import com.google.gdata.util.ServiceException;
 
 /**
  * Connector for accessing, creating and modifying google docs spreadsheets.
  * This connector uses OAuth2 for authentication.
  *
  * @author mariano.gonzalez@mulesoft.com
  */
 @Connector(name="google-spreadsheets", schemaVersion="1.0", friendlyName="Google Spreadsheets", minMuleVersion="3.5", configElementName="config-with-oauth")
 @OAuth2(
 		authorizationUrl = "https://accounts.google.com/o/oauth2/auth",
 		accessTokenUrl = "https://accounts.google.com/o/oauth2/token",
 		accessTokenRegex="\"access_token\"[ ]*:[ ]*\"([^\\\"]*)\"",
 		expirationRegex="\"expires_in\"[ ]*:[ ]*([\\d]*)",
 		refreshTokenRegex="\"refresh_token\"[ ]*:[ ]*\"([^\\\"]*)\"",
 		authorizationParameters={
 				@OAuthAuthorizationParameter(name="access_type", defaultValue="online", type=AccessType.class, description="Indicates if your application needs to access a Google API when the user is not present at the browser. " + 
 											" Use offline to get a refresh token and use that when the user is not at the browser. Default is online", optional=true),
 				@OAuthAuthorizationParameter(name="force_prompt", defaultValue="auto", type=ForcePrompt.class, description="Indicates if google should remember that an app has been authorized or if each should ask authorization every time. " + 
 											" Use force to request authorization every time or auto to only do it the first time. Default is auto", optional=true)
 		}
 )
 public class GoogleSpreadSheetConnector extends AbstractGoogleOAuthConnector {
 	
 	private static Logger logger = Logger.getLogger(GoogleSpreadSheetConnector.class);
 	
 	/**
      * The OAuth consumer key 
      */
     @Configurable
     @OAuthConsumerKey
     private String consumerKey;
 
     /**
      * The OAuth consumer secret 
      */
     @Configurable
     @OAuthConsumerSecret
     private String consumerSecret;
     
     /**
      * The OAuth scopes you want to request
      */
     @OAuthScope
     @Configurable
     @Optional
     @Default(USER_PROFILE_SCOPE + " https://spreadsheets.google.com/feeds https://docs.google.com/feeds")
     private String scope;
     
     private FeedURLFactory factory = FeedURLFactory.getDefault();
     
     /**
      * Application name to communicate to google
      */
     @Configurable
     @Optional
     @Default("Mule-GoogleSpreadsheetsConnector/1.0")
     private String applicationName;
     
     @OAuthAccessToken
     private String accessToken;
     
 	private SpreadsheetService spreadsheetService;
 	
 	private DocsService docService;
 	
 	@OAuthPostAuthorization
 	public void postAuth() {
 		Credential credential = new InvalidationAwareCredential(BearerToken.authorizationHeaderAccessMethod());
 		credential.setAccessToken(this.getAccessToken());
 		
 		this.spreadsheetService = new SpreadsheetService(this.applicationName);
 		this.spreadsheetService.setOAuth2Credentials(credential);
 		setHeaderValue("*");
 		
 		this.docService = new DocsService(this.applicationName);
 		this.docService.setOAuth2Credentials(credential);
 	}
 
 	private void setHeaderValue(String value) {
 		if(this.spreadsheetService!=null)
 			this.spreadsheetService.setHeader("If-Match", value);
 	}
 	
     /**
      * Returns all the spreadsheets associated with the user's account
      * 
      * {@sample.xml ../../../doc/GoogleSpreadSheets-connector.xml.sample GoogleSpreadSheets:get-all-spreadsheets}
      * 
      * @return a list of @{link org.mule.module.google.spreadsheet.model.Spreadsheet}
      * @throws OAuthException if there's an error authenticating
      * @throws IOException if there's a communication error with google's servers
      * @throws ServiceException if the operation raises an error on google's end
      */
     @Processor
     @OAuthProtected
 	@OAuthInvalidateAccessTokenOn(exception=OAuthTokenExpiredException.class)
     public List<Spreadsheet> getAllSpreadsheets() throws OAuthException, IOException, ServiceException {
         return ModelParser.parseSpreadsheet(this.spreadsheetService.getFeed(factory.getSpreadsheetsFeedUrl(), SpreadsheetFeed.class));
     }
     
  
     /**
      * Creates a new spreadsheet using a given title
      *  
     * {@sample.xml ../../../doc/GoogleSpreadSheets-connector.xml.sample GoogleSpreadSheets:get-all-spreadsheets}
      *  
      * @param title the title you want the new spreadsheet to have
      * @throws OAuthException if there's an error authenticating
      * @throws IOException if there's a communication error with google's servers
      * @throws ServiceException if the operation raises an error on google's end
      */
     @Processor
     @OAuthProtected
 	@OAuthInvalidateAccessTokenOn(exception=OAuthTokenExpiredException.class)
     public void createSpreadsheet(String title) throws OAuthException, IOException, ServiceException {
 
     	com.google.gdata.data.docs.SpreadsheetEntry newEntry = new com.google.gdata.data.docs.SpreadsheetEntry();
     	
     	newEntry.setTitle(new PlainTextConstruct(title));
         this.docService.insert(new URL("https://docs.google.com/feeds/default/private/full"), newEntry);
     }
     
     /**
      * Lists all the worksheets contained in an specified spreadsheet
      * 
      * {@sample.xml ../../../doc/GoogleSpreadSheets-connector.xml.sample GoogleSpreadSheets:get-all-worksheets}
      * 
      * @param spreadsheet the title of the spreadsheet you want to get the worksheets from
      * @param spreadsheetIndex google's api allows for several spreadsheet to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @return a list of {@link org.mule.module.google.spreadsheet.model.Worksheet}
      * @throws IOException if there's a communication error with google's servers
      * @throws ServiceException if the operation raises an error on google's end
      */
     @Processor
     @OAuthProtected
 	@OAuthInvalidateAccessTokenOn(exception=OAuthTokenExpiredException.class)
     public List<Worksheet> getAllWorksheets(String spreadsheet, @Optional @Default("0") int spreadsheetIndex) throws IOException, ServiceException {
     	
     	SpreadsheetEntry ss = this.getSpreadsheetEntry(spreadsheet, spreadsheetIndex);
     	return ModelParser.parseWorksheet(ss.getWorksheets());
     }
     
     /**
      * Creates a new worksheet for an specified spreadsheet
      * 
      * {@sample.xml ../../../doc/GoogleSpreadSheets-connector.xml.sample GoogleSpreadSheets:create-worksheet}
      *  
      * @param spreadsheet the title of the spreadsheet that will contain the new worksheet
      * @param spreadsheetIndex google's api allows for several spreadsheet to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @param title the title you want the new worksheet to have
      * @param rowCount the initial number of rows you want the worksheet to have
      * @param colCount the initial number of columns you want the worksheet to have
      * @return an instance of {@link org.mule.module.google.spreadsheet.model.Worksheet} representing the newly created worksheet
      * @throws IOException if there's a communication error with google's servers
      * @throws ServiceException if the operation raises an error on google's end
      */
     @Processor
     @OAuthProtected
 	@OAuthInvalidateAccessTokenOn(exception=OAuthTokenExpiredException.class)
     public Worksheet createWorksheet(
 			String spreadsheet,
     		@Optional @Default("0") int spreadsheetIndex,
     		String title,
     		int rowCount,
     		int colCount) throws IOException, ServiceException {
     	
     	SpreadsheetEntry ss = this.getSpreadsheetEntry(spreadsheet, spreadsheetIndex);
     	WorksheetEntry ws = new WorksheetEntry();
     	ws.setTitle(new PlainTextConstruct(title));
     	ws.setRowCount(rowCount);
     	ws.setColCount(colCount);
     	//This flag is not required when inserting a worksheet and if set, will make the call fail
     	setHeaderValue(null);
     	ws = this.spreadsheetService.insert(ss.getWorksheetFeedUrl(), ws);
     	setHeaderValue("*");
     	return new Worksheet(ws);
     }
     
     /**
      * Deletes an specified worksheet
      * 
      * {@sample.xml ../../../doc/GoogleSpreadSheets-connector.xml.sample GoogleSpreadSheets:delete-worksheet}
      * 
      * @param spreadsheet the title of the spreadsheet that contains the worksheet to be deleted
      * @param worksheet  the title of the worksheet you want to delete
      * @param spreadsheetIndex google's api allows for several spreadsheet to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @param worksheetIndex google's api allows for several worksheets to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @throws IOException if there's a communication error with google's servers
      * @throws ServiceException if the operation raises an error on google's end
      */
     @Processor
     @OAuthProtected
 	@OAuthInvalidateAccessTokenOn(exception=OAuthTokenExpiredException.class)
     public void deleteWorksheet(
 					String spreadsheet,
 		    		String worksheet,
 		    		@Optional @Default("0") int spreadsheetIndex,
 		    		@Optional @Default("0") int worksheetIndex) throws IOException, ServiceException {
     	
     	WorksheetEntry ws = this.getItem(this.getWorksheetEntriesByTitle(spreadsheet, worksheet, spreadsheetIndex), worksheetIndex);
     	ws.delete();
     }
     
     /**
      * 
      * This processor allows updating a worksheet's metadata, constituted by
      * its title, dimensions, summary, draft and editability status.
      * 
      * {@sample.xml ../../../doc/GoogleSpreadSheets-connector.xml.sample GoogleSpreadSheets:update-worksheet-metadata}
      * 
      * @param spreadsheet the title of the spreadsheet you want to update
      * @param worksheet  the title of the worksheet you want to update
      * @param title if specified, it changes the title you want to set
      * @param draft if specified, it changes the value of the draft property
      * @param canEdit if specified, it changes the worksheet's editability
      * @param summary if specified, it changes the worksheet's summary
      * @param rowCount if a value greater than zero is specified, it changes the amount of rows in the worksheet
      * @param colCount if a value greater than zero is specified, it changes the amount of columns in the worksheet
      * @param spreadsheetIndex google's api allows for several spreadsheet to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @param worksheetIndex google's api allows for several worksheets to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @throws IOException if there's a communication error with google's servers
      * @throws ServiceException if the operation raises an error on google's end
      */
     @Processor
     @OAuthProtected
 	@OAuthInvalidateAccessTokenOn(exception=OAuthTokenExpiredException.class)
     public void updateWorksheetMetadata(
 			String spreadsheet,
     		String worksheet,
     		@Optional @Default("") String title,
     		@Optional Boolean draft,
     		@Optional Boolean canEdit,
     		@Optional @Default("") String summary,
     		@Optional @Default("0") int rowCount,
     		@Optional @Default("0") int colCount,
     		@Optional @Default("0") int spreadsheetIndex,
 			@Optional @Default("0") int worksheetIndex) throws IOException, ServiceException {
     	
     	WorksheetEntry ws = this.getWorksheetEntry(accessToken, spreadsheet, worksheet, spreadsheetIndex, worksheetIndex);
 		
     	if (!StringUtils.isEmpty(title)) {
     		ws.setTitle(new PlainTextConstruct(title));
     	}
     	
     	if (draft != null) {
     		ws.setDraft(draft);
     	}
     	
     	if (rowCount > 0) {
     		ws.setRowCount(rowCount);
     	}
     	
     	if (colCount > 0) {
     		ws.setColCount(colCount);
     		
     	}
     	
     	if (canEdit != null) {
     		ws.setCanEdit(canEdit);
     	}
     	
     	if (!StringUtils.isEmpty(summary)) {
     		ws.setSummary(new PlainTextConstruct(summary));
     	}
     	
     	ws.update();
     }
     
     /**
      * Performs a batch update of a worksheet's cells taking values from a list of {@link org.mule.module.google.spreadsheet.model.Row}
      * taken from the message payload.
      * 
      * {@sample.xml ../../../doc/GoogleSpreadSheets-connector.xml.sample GoogleSpreadSheets:set-row-values}
      * 
      * @param rows a list of {@link org.mule.module.google.spreadsheet.model.Row} taken from the message payload describing the values to be set
      * @param spreadsheet the title of the spreadsheet you want to update
      * @param worksheet  the title of the worksheet you want to update
      * @param spreadsheetIndex google's api allows for several spreadsheet to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @param worksheetIndex google's api allows for several worksheets to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @param purge if true, the worksheet will be purged before the values are set
      * @throws Exception if an error occurs
      */
     @Processor
     @OAuthProtected
 	@OAuthInvalidateAccessTokenOn(exception=OAuthTokenExpiredException.class)
     public void setRowValues(
 			@Optional @Default("#[payload:]") List<Row> rows,
 			String spreadsheet,
     		String worksheet,
     		@Optional @Default("0") int spreadsheetIndex,
 			@Optional @Default("0") int worksheetIndex,
 			@Optional @Default("false") boolean purge) throws Exception {
     	
     	if (rows == null || rows.isEmpty()) {
     		logger.warn("Worksheet contains no rows... skipping update and possible purge");
     		return;
     	}
     	
     	if (purge) {
     		this.purgeWorksheet(spreadsheet, worksheet, spreadsheetIndex, worksheetIndex);
     	}
     	
     	URL cellFeedUrl = this.getWorksheetEntry(accessToken, spreadsheet, worksheet, spreadsheetIndex, worksheetIndex).getCellFeedUrl();
     	CellFeed batchRequest = new CellFeed();
     	
     	for (Row row : rows) {
     		for (Cell cell : row.getCells()) {
     			String batchId = "R" + row.getRowNumber() + "C" + cell.getColumnNumber();
     			URL entryUrl = new URL(cellFeedUrl.toString() + "/" + batchId);
     			CellEntry batchOperation = this.spreadsheetService.getEntry(entryUrl, CellEntry.class);
     			batchOperation.changeInputValueLocal(cell.getValueOrFormula());
     			BatchUtils.setBatchId(batchOperation, batchId);
     			BatchUtils.setBatchOperationType(batchOperation, BatchOperationType.UPDATE);
     			batchRequest.getEntries().add(batchOperation);
     		}
     	}
     	
         // Get the batch feed URL and submit the batch requests
         CellFeed feed = this.spreadsheetService.getFeed(cellFeedUrl, CellFeed.class);
         Link batchLink = feed.getLink(Link.Rel.FEED_BATCH, Link.Type.ATOM);
         URL batchUrl = new URL(batchLink.getHref());
         
         this.spreadsheetService.batch(batchUrl, batchRequest);
     }
     
     /**
      * 
      * Performs a batch update of a worksheet's cells taking values from a csv String.
      * This csv file can have multiple lines and columns and you get to specify what those separators are. 
      * You can manually specify the csv string or else it will automatically taken from the message payload
      * 
      * {@sample.xml ../../../doc/GoogleSpreadSheets-connector.xml.sample GoogleSpreadSheets:set-csv-values}
      * 
      * @param rows a list of {@link org.mule.module.google.spreadsheet.model.Row} taken from the message payload describing the values to be set
      * @param spreadsheet the title of the spreadsheet you want to update
      * @param worksheet  the title of the worksheet you want to update
      * @param csv the csv content to be set on the worksheet. You can manually specify it or else it will be taken from the message payload
      * @param startingRow the number of the row where the first line of the csv will be set into. This is a 1-based index
      * @param startingColumn the number of the column where the first value of each line of the csv will be set into. This is a 1-based index
      * @param lineSeparator specifies the character to be used as a line separator. Defaults to the new line <code>\n</code> character
      * @param columnSeparator specifies the character to be used as a column sperator. Defaults to a comma character
      * @param spreadsheetIndex google's api allows for several spreadsheet to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @param worksheetIndex google's api allows for several worksheets to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @param purge if true, the worksheet will be purged before the values are set
      * @throws Exception if an error occurs
      */
     @Processor
     @OAuthProtected
 	@OAuthInvalidateAccessTokenOn(exception=OAuthTokenExpiredException.class)
     public void setCsvValues(
 			String spreadsheet,
     		String worksheet,
     		@Optional @Default("#[payload:]") String csv,
     		@Optional @Default("1") int startingRow,
     		@Optional @Default("1") int startingColumn,
     		@Optional @Default("\n") String lineSeparator,
     		@Optional @Default(",") String columnSeparator,
     		@Optional @Default("0") int spreadsheetIndex,
 			@Optional @Default("0") int worksheetIndex,
 			@Optional @Default("false") boolean purge) throws Exception {
     	
     	if (StringUtils.isEmpty(csv)) {
     		if (logger.isDebugEnabled()) {
     			logger.debug("received empty csv value... exiting without updating values nor purging");
     		}
     		return;
     	}
     	
     	if (StringUtils.isEmpty(lineSeparator)) {
     		lineSeparator = "\n";
     	}
     	
     	if (StringUtils.isEmpty(",")) {
     		columnSeparator = ",";
     	}
     	
     	List<Row> rows = CsvToRowsAdapter.adapt(csv, startingRow, startingColumn, columnSeparator, lineSeparator);
     	this.setRowValues(rows, spreadsheet, worksheet, spreadsheetIndex, worksheetIndex, purge);
     }
 
     /**
      * Returns a list of {@link com.google.gdata.data.Person} where each entry represent a a contributor
      * on a specified spreadsheet
      * 
      * {@sample.xml ../../../doc/GoogleSpreadSheets-connector.xml.sample GoogleSpreadSheets:get-authors}
      * 
      * @param spreadsheet the title of the spreadsheet from which the info should be taken from
      * @param spreadsheetIndex google's api allows for several spreadsheet to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @return a list of {@link com.google.gdata.data.Person} where each entry represent a spreadsheet's contributor
      * @throws IOException if there's a communication error with google's servers
      * @throws ServiceException if the operation raises an error on google's end
      */
     @Processor
     @OAuthProtected
 	@OAuthInvalidateAccessTokenOn(exception=OAuthTokenExpiredException.class)
     public List<Person> getAuthors(String spreadsheet, @Optional @Default("0") int spreadsheetIndex) throws IOException, ServiceException {
     	
     	return this.getSpreadsheetEntry(spreadsheet, spreadsheetIndex).getAuthors();
     }
     
     /**
      * This processor returns the a worksheet's first row
      * 
      * {@sample.xml ../../../doc/GoogleSpreadSheets-connector.xml.sample GoogleSpreadSheets:get-column-headers}
      * 
      * @param spreadsheet the title of the spreadsheet from which the info should be taken from
      * @param worksheet the title of the worksheet from which the info should be taken from
      * @param spreadsheetIndex google's api allows for several spreadsheet to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @param worksheetIndex google's api allows for several worksheets to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @return an instance of  {@link org.mule.module.google.spreadsheet.model.Row} is the worksheet has a first row
      * 			initialized, null otherwise
      * @throws IOException if there's a communication error with google's servers
      * @throws ServiceException if the operation raises an error on google's end
      */
     @Processor
     @OAuthProtected
 	@OAuthInvalidateAccessTokenOn(exception=OAuthTokenExpiredException.class)
     public Row getColumnHeaders(
 			String spreadsheet,
     		String worksheet,
     		@Optional @Default("0") int spreadsheetIndex,
 			@Optional @Default("0") int worksheetIndex) throws IOException, ServiceException {
     	
     	
 		WorksheetEntry worksheetEntry = this.getWorksheetEntry(accessToken, spreadsheet, worksheet, spreadsheetIndex, worksheetIndex);
     	
 		// Get the appropriate URL for a cell feed
 		URL cellFeedUrl = worksheetEntry.getCellFeedUrl();
 
 		// Create a query for the top row of cells only (1-based)
 		CellQuery cellQuery = new CellQuery(cellFeedUrl);
 		cellQuery.setMaximumRow(1);
 
 		// Get the cell feed matching the query
 		CellFeed topRowCellFeed = this.spreadsheetService.query(cellQuery, CellFeed.class);
 
 		List<Row> rows = ModelParser.parseCell(topRowCellFeed);
 		
 		return rows.isEmpty() ? null : rows.get(0);
     }
     
     /**
      * Returns a list of {@link org.mule.module.google.spreadsheet.model.Spreadsheet} with all the spreadsheets
      * associated with the user which title matches the one specified.
      * 
      * {@sample.xml ../../../doc/GoogleSpreadSheets-connector.xml.sample GoogleSpreadSheets:get-spreadsheets-by-title}
      * 
      * @param title the title to be used in the search
      * @return a list of {@link org.mule.module.google.spreadsheet.model.Spreadsheet}
      * @throws IOException if there's a communication error with google's servers
      * @throws ServiceException if the operation raises an error on google's end
      */
     @Processor
     @OAuthProtected
 	@OAuthInvalidateAccessTokenOn(exception=OAuthTokenExpiredException.class)
     public List<Spreadsheet> getSpreadsheetsByTitle(String title) throws IOException, ServiceException {
     	SpreadsheetQuery spreadsheetQuery = new SpreadsheetQuery(factory.getSpreadsheetsFeedUrl());
         spreadsheetQuery.setTitleQuery(title);
         return ModelParser.parseSpreadsheet(this.spreadsheetService.query(spreadsheetQuery, SpreadsheetFeed.class));
     }
 
     /**
      * Returns a list of {@link org.mule.module.google.spreadsheet.model.Worksheet} 
      * which title matches the one specified. This is not a global search. Only worksheets
      * attached to a specified spreadsheet will be considered
      * 
      * {@sample.xml ../../../doc/GoogleSpreadSheets-connector.xml.sample GoogleSpreadSheets:get-worksheet-by-title}
      * 
      * @param spreadsheet the title of the spreadsheet in which you want to perform the search
      * @param title the title to be used in the search
      * @param spreadsheetIndex google's api allows for several spreadsheet to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @return a list of {@link org.mule.module.google.spreadsheet.model.Worksheet} 
      * @throws IOException if there's a communication error with google's servers
      * @throws ServiceException if the operation raises an error on google's end
      */
     @Processor
     @OAuthProtected
 	@OAuthInvalidateAccessTokenOn(exception=OAuthTokenExpiredException.class)
     public List<Worksheet> getWorksheetByTitle(
     							String spreadsheet,
     				    		String title,
     				    		@Optional @Default("0") int spreadsheetIndex) throws IOException, ServiceException {
     	
     	return ModelParser.parseWorksheet(this.getWorksheetEntriesByTitle(spreadsheet, title, spreadsheetIndex));
     }
     
     /**
      * This processors deletes all the cell entries of a specified worksheet.
      * 
      * {@sample.xml ../../../doc/GoogleSpreadSheets-connector.xml.sample GoogleSpreadSheets:purge-worksheet}
      * 
      * @param spreadsheet the title of the spreadsheet containing the worksheet to be purged
      * @param worksheet the title of the worksheet to be purged
      * @param spreadsheetIndex google's api allows for several spreadsheet to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @param worksheetIndex google's api allows for several worksheets to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @throws IOException if there's a communication error with google's servers
      * @throws ServiceException if the operation raises an error on google's end
      */
     @Processor
     @OAuthProtected
 	@OAuthInvalidateAccessTokenOn(exception=OAuthTokenExpiredException.class)
     public void purgeWorksheet(
 			String spreadsheet,
     		String worksheet,
     		@Optional @Default("0") int spreadsheetIndex,
 			@Optional @Default("0") int worksheetIndex) throws IOException, ServiceException {
     	
     	WorksheetEntry worksheetEntry = this.getWorksheetEntry(accessToken, spreadsheet, worksheet, spreadsheetIndex, worksheetIndex);
     	
     	CellFeed cellFeed = this.spreadsheetService.getFeed(worksheetEntry.getCellFeedUrl(), CellFeed.class);
 
     	for (CellEntry cell : cellFeed.getEntries()) {
     		cell.delete();
     	}
     }
     
     /**
      * Returns a list of {@link org.mule.module.google.spreadsheet.model.Row} in which each
      * entry represents one of the initialized cells on a worksheet
      * 
      * {@sample.xml ../../../doc/GoogleSpreadSheets-connector.xml.sample GoogleSpreadSheets:get-all-cells}
      * 
      * @param spreadsheet the title of the spreadsheet containing the worksheet on which the cells are
      * @param worksheet the title of the worksheet containing the cells you want to get
      * @param spreadsheetIndex google's api allows for several spreadsheet to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @param worksheetIndex google's api allows for several worksheets to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @return a list of {@link org.mule.module.google.spreadsheet.model.Cell}
      * @throws IOException if there's a communication error with google's servers
      * @throws ServiceException if the operation raises an error on google's end
      */
     @Processor
     @OAuthProtected
 	@OAuthInvalidateAccessTokenOn(exception=OAuthTokenExpiredException.class)
     public List<Row> getAllCells(
 			String spreadsheet,
     		String worksheet,
     		@Optional @Default("0") int spreadsheetIndex,
 			@Optional @Default("0") int worksheetIndex) throws IOException, ServiceException {
     	
     	WorksheetEntry worksheetEntry = this.getWorksheetEntry(accessToken, spreadsheet, worksheet, spreadsheetIndex, worksheetIndex);
 
     	// Get the appropriate URL for a cell feed
     	URL cellFeedUrl = worksheetEntry.getCellFeedUrl();
     	return ModelParser.parseCell(this.spreadsheetService.getFeed(cellFeedUrl, CellFeed.class));
     }
     
     /**
      * Returns a CSV file representing all the initialized cells in a worksheet.
      * Athough this method is intended for generating a CSV file, notice that
      * the column and line separator are customizable so you could use it
      * to generated a text delimited file that is not strictly speaking a CSV.
      * 
      * The generated file will have one line per cell and the following columns structure
      * 
      * Row Number | Column Number | evaluated Value
      * 
      * {@sample.xml ../../../doc/GoogleSpreadSheets-connector.xml.sample GoogleSpreadSheets:get-all-cells-as-csv}
      * 
      * @param spreadsheet the title of the spreadsheet containing the worksheet on which the cells are
      * @param worksheet the title of the worksheet containing the cells you want to get
      * @param spreadsheetIndex google's api allows for several spreadsheet to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @param worksheetIndex google's api allows for several worksheets to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @param lineSeparator specifies the character to be used as a line separator. Defaults to the new line <code>\n</code> character
      * @param columnSeparator specifies the character to be used as a column sperator. Defaults to a comma character
      * @return a list of {@link org.mule.module.google.spreadsheet.model.Cell}
      * @throws IOException if there's a communication error with google's servers
      * @throws ServiceException if the operation raises an error on google's end
      */
     @Processor
     @OAuthProtected
 	@OAuthInvalidateAccessTokenOn(exception=OAuthTokenExpiredException.class)
     public String getAllCellsAsCsv(
 			String spreadsheet,
     		String worksheet,
     		@Optional @Default(",") String columnSeparator,
 			@Optional @Default("\n") String lineSeparator,
     		@Optional @Default("0") int spreadsheetIndex,
 			@Optional @Default("0") int worksheetIndex) throws IOException, ServiceException {
     	
     	if (StringUtils.isEmpty(lineSeparator)) {
     		lineSeparator = "\n";
     	}
     	
     	if (StringUtils.isEmpty(",")) {
     		columnSeparator = ",";
     	}
     	
     	return ModelParser.toCSV(this.getAllCells(spreadsheet, worksheet, spreadsheetIndex, worksheetIndex),
     				lineSeparator, columnSeparator);
     }
     
     /**
      * Returns a list of {@link org.mule.module.google.spreadsheet.model.Row} containing
      * the cells contained in a given range
      * 
      * {@sample.xml ../../../doc/GoogleSpreadSheets-connector.xml.sample GoogleSpreadSheets:get-cell-range}
      * 
      * @param accessToken OAuth accessToken
      * @param spreadsheet the title of the spreadsheet containing the worksheet on which the cells are 
      * @param worksheet the title of the worksheet containing the cells you want to get
      * @param spreadsheetIndex google's api allows for several spreadsheet to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @param worksheetIndex google's api allows for several worksheets to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @param minRow the range starting row. This is a 1-based index
      * @param maxRow the range ending row. This is a 1-based index
      * @param minCol the range starting column. This is a 1-based index
      * @param maxCol the range ending column. This is a 1-based index
      * @return a list of {@link org.mule.module.google.spreadsheet.model.Row}
      * @throws IOException if there's a communication error with google's servers
      * @throws ServiceException if the operation raises an error on google's end
      */
     @Processor
     @OAuthProtected
 	@OAuthInvalidateAccessTokenOn(exception=OAuthTokenExpiredException.class)
     public List<Row> getCellRange(
 			String spreadsheet,
 			String worksheet,
     		@Optional @Default("0") int spreadsheetIndex,
 			@Optional @Default("0") int worksheetIndex,
     		int minRow,
     		int maxRow,
     		int minCol,
     		int maxCol) throws IOException, ServiceException {
       
     	CellQuery query = new CellQuery(this.getCellFeedUrl(spreadsheet, worksheet, spreadsheetIndex, worksheetIndex));
     	query.setMinimumRow(minRow);
 	    query.setMaximumRow(maxRow);
 	    query.setMinimumCol(minCol);
 	    query.setMaximumCol(maxCol);
 	    
 	    return ModelParser.parseRows(this.spreadsheetService.query(query, CellFeed.class));
     }
     
     /**
      * Returns a CSV file representing the requested cell range.
      * Athough this method is intended for generating a CSV file, notice that
      * the column and line separator are customizable so you could use it
      * to generated a text delimited file that is not strictly speaking a CSV.
      * 
      * The generated file will have one line per cell and the following columns structure
      * 
      * Row Number | Column Number | evaluated Value
      * 
      * {@sample.xml ../../../doc/GoogleSpreadSheets-connector.xml.sample GoogleSpreadSheets:get-cell-range-as-csv}
      * 
      * @param spreadsheet the title of the spreadsheet containing the worksheet on which the cells are 
      * @param worksheet the title of the worksheet containing the cells you want to get
      * @param spreadsheetIndex google's api allows for several spreadsheet to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @param worksheetIndex google's api allows for several worksheets to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @param minRow the range starting row. This is a 1-based index
      * @param maxRow the range ending row. This is a 1-based index
      * @param minCol the range starting column. This is a 1-based index
      * @param maxCol the range ending column. This is a 1-based index
      * @param lineSeparator specifies the character to be used as a line separator. Defaults to the new line <code>\n</code> character
      * @param columnSeparator specifies the character to be used as a column sperator. Defaults to a comma character
      * @return a list of {@link org.mule.module.google.spreadsheet.model.Row}
      * @throws IOException if there's a communication error with google's servers
      * @throws ServiceException if the operation raises an error on google's end
      */
     @Processor
     @OAuthProtected
 	@OAuthInvalidateAccessTokenOn(exception=OAuthTokenExpiredException.class)
     public String getCellRangeAsCsv(
 			String spreadsheet,
 			String worksheet,
 			@Optional @Default("0") int spreadsheetIndex,
 			@Optional @Default("0") int worksheetIndex,
 			@Optional @Default(",") String columnSeparator,
 			@Optional @Default("\n") String lineSeparator,
 			int minRow,
 			int maxRow,
 			int minCol,
 			int maxCol) throws IOException, ServiceException {
     	
     	if (StringUtils.isEmpty(lineSeparator)) {
     		lineSeparator = "\n";
     	}
     	
     	if (StringUtils.isEmpty(",")) {
     		columnSeparator = ",";
     	}
     	
     	List<Row> rows = this.getCellRange(spreadsheet, worksheet, 
     			spreadsheetIndex, worksheetIndex, minRow, maxRow, minCol, maxCol);
     	
     	return ModelParser.toCSV(rows, lineSeparator, columnSeparator);
     }
 
     /**
      * Performs a full-text search on a worksheet and returns a list of {@link org.mule.module.google.spreadsheet.model.Row} 
      * in which each entry represent a cell containing a matching value
      * 
      * {@sample.xml ../../../doc/GoogleSpreadSheets-connector.xml.sample GoogleSpreadSheets:search}
      * 
      * @param spreadsheet the title of the spreadsheet containing the worksheet on which the cells are 
      * @param worksheet the title of the worksheet containing the cells you want to get
      * @param query a full text search string, with space-separated keywords
      * @param spreadsheetIndex google's api allows for several spreadsheet to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @param worksheetIndex google's api allows for several worksheets to have the same name. In this cases
      * 							it returns a list with all the ones matching the given title. Use this optional
      * 							attribute to specify the zero-based list index of the want you want to use
      * @return a list of {@link org.mule.module.google.spreadsheet.model.Cell}
      * @throws IOException if there's a communication error with google's servers
      * @throws ServiceException if the operation raises an error on google's end
      */
     @Processor
     @OAuthProtected
 	@OAuthInvalidateAccessTokenOn(exception=OAuthTokenExpiredException.class)
     public List<Row> search(
 			String spreadsheet,
     		String worksheet,
     		String query,
     		@Optional @Default("0") int spreadsheetIndex,
 			@Optional @Default("0") int worksheetIndex) throws IOException, ServiceException {
     	
       CellQuery cellQuery = new CellQuery(this.getCellFeedUrl(spreadsheet, worksheet, spreadsheetIndex, worksheetIndex));
       cellQuery.setFullTextQuery(query);
       
       return ModelParser.parseCell(this.spreadsheetService.query(cellQuery, CellFeed.class));
     }
     
     private SpreadsheetEntry getSpreadsheetEntry(
     		String spreadsheet,
     		int spreadsheetIndex) throws IOException, ServiceException {
     	
     	SpreadsheetQuery spreadsheetQuery = new SpreadsheetQuery(factory.getSpreadsheetsFeedUrl());
         spreadsheetQuery.setTitleQuery(spreadsheet);
     	return this.getItem(this.spreadsheetService.query(spreadsheetQuery, SpreadsheetFeed.class).getEntries(), spreadsheetIndex);
     }
     
     private List<WorksheetEntry> getWorksheetEntriesByTitle(
 											String spreadsheet,
 											String worksheet,
 											int spreadsheetIndex) throws IOException, ServiceException {
     	
     	SpreadsheetEntry spreadsheetEntry = this.getSpreadsheetEntry(spreadsheet, spreadsheetIndex);
     	
     	WorksheetQuery worksheetQuery = new WorksheetQuery(spreadsheetEntry.getWorksheetFeedUrl());
     	worksheetQuery.setTitleQuery(worksheet);
     	return this.spreadsheetService.query(worksheetQuery, WorksheetFeed.class).getEntries();
     }
     
     private WorksheetEntry getWorksheetEntry(
     		String accessToken,
 			String spreadsheet,
     		String worksheet,
     		int spreadsheetIndex,
     		int worksheetIndex) throws IOException, ServiceException {
     	
     	List<WorksheetEntry> worksheets = this.getWorksheetEntriesByTitle(spreadsheet, worksheet, spreadsheetIndex);
     	return this.getItem(worksheets, worksheetIndex);
     }
     
     private URL getCellFeedUrl(
     		String spreadsheet,
     		String worksheet,
     		int spreadsheetIndex,
     		int worksheetIndex) throws IOException, ServiceException {
     	
     	return this.getWorksheetEntry(accessToken, spreadsheet, worksheet, spreadsheetIndex, worksheetIndex).getCellFeedUrl();
     }
     
     private <T> T getItem(List<T> list, int index) {
     	if (list.isEmpty()) {
     		throw new IllegalArgumentException("No item found for that name");
     	} else if (index >= list.size()) {
     		throw new IllegalArgumentException("You requested item index " + index + 
     											" but only " + list.size() + " were found");
     	}
     	
     	return list.get(index);
     }
     
 	public String getConsumerKey() {
 		return consumerKey;
 	}
 
 	public void setConsumerKey(String consumerKey) {
 		this.consumerKey = consumerKey;
 	}
 
 	public String getConsumerSecret() {
 		return consumerSecret;
 	}
 
 	public void setConsumerSecret(String consumerSecret) {
 		this.consumerSecret = consumerSecret;
 	}
 
 	public String getScope() {
 		return scope;
 	}
 
 	public void setScope(String scope) {
 		this.scope = scope;
 	}
 
 	public String getApplicationName() {
 		return applicationName;
 	}
 
 	public void setApplicationName(String applicationName) {
 		this.applicationName = applicationName;
 	}
 
 	@Override
 	public String getAccessToken() {
 		return accessToken;
 	}
 
 	public void setAccessToken(String accessToken) {
 		this.accessToken = accessToken;
 	}
 
 	public void setSpreadsheetService(SpreadsheetService spreadsheetService) {
 		this.spreadsheetService = spreadsheetService;
 	}
 
 	public void setDocService(DocsService docService) {
 		this.docService = docService;
 	}
 	
 }
