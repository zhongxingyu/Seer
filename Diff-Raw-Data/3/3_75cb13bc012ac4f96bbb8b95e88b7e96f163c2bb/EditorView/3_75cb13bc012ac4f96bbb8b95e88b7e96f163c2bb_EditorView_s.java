 package view;
 
 import javax.swing.JFrame;
 import javax.swing.JMenu;
 import javax.swing.JMenuBar;
 import javax.swing.JMenuItem;
 import javax.swing.KeyStroke;
 
 import model.Mail;
 import model.Mail.MailType;
 import model.Mailbox;
 import model.Mediator;
 import model.Session;
 import cmd.*;
 import construct.*;
 import model.HTMLBuffer;
 
 import java.awt.BorderLayout;
 import java.awt.Component;
 import java.awt.Dimension;
 import java.awt.GridLayout;
 import java.awt.event.InputEvent;
 import java.util.ArrayList;
 import java.util.HashMap;
 import java.util.Observable;
 import java.util.Observer;
 
 import java.awt.event.KeyEvent;
 import javax.swing.*;
 import javax.swing.event.ChangeEvent;
 import javax.swing.event.ChangeListener;
 
 import java.awt.event.*;
 import java.io.File;
 
 public class EditorView extends JFrame implements Observer
 {
     private static final long serialVersionUID = -1313466314283507875L;
 
     private HashMap<Class<?>, Command> commands;
     
     private String listType;
     
     /**
      * Stores commands generated by Client
      * 
      * @param commands
      *        a HashMap relating a command's class object to an instantiated
      *        version of the real Command object
      */
     public void storeCommands(HashMap<Class<?>, Command> commands)
     {
         this.commands = commands;
     }
     
     @SuppressWarnings("unused")
     private JMenuBar mb = new JMenuBar();
     
     private JTabbedPane tabs;
     public EditorView()
     {
         tabs = new JTabbedPane();
         
         //Add listener for tab changes
         tabs.addChangeListener(new ChangeListener(){
            public void stateChanged(ChangeEvent e){
                HTMLBuffer currentBuffer = (HTMLBuffer)(tabs.getSelectedComponent());
                Context c = new Context();
                c.setBuffer(currentBuffer);
                commands.get(CmdSetCurrentTab.class).execute(c);
            }
         });
 
         // |--+ {File} Menu
         JMenu muFile = new JMenu("File");
         //    |-- {Open} Menu Item
         JMenuItem miOpen = new JMenuItem("Open");
         miOpen.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_O,InputEvent.CTRL_DOWN_MASK));
         miOpen.addActionListener(new ActionListener(){
                 public void actionPerformed(ActionEvent e){
                     File file = openChooser(false);
                     Context c = new Context();
                     c.setFile(file);
                     commands.get(CmdOpen.class).execute(c);
                 }
         });
         muFile.add(miOpen);
         //    |-- {New} Menu Item
         JMenuItem miNew = new JMenuItem("New");
         miNew.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_N,InputEvent.CTRL_DOWN_MASK));
         miNew.addActionListener(new ActionListener(){
             public void actionPerformed(ActionEvent e){
                 commands.get(CmdNew.class).execute(new Context());
             }
         });
         muFile.add(miNew);
         //    |-- {Save} Menu Item
         JMenuItem miSave = new JMenuItem("Save");
         miSave.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_S,InputEvent.CTRL_DOWN_MASK));
         miSave.addActionListener(new ActionListener(){
             public void actionPerformed(ActionEvent e){
                File file = openChooser(true);
                 Context c = new Context();
                c.setFile(file);
                 commands.get(CmdSave.class).execute(c);
             }
         });
         muFile.add(miSave);
         //    |-- {Save As} Menu Item
         JMenuItem miSaveAs = new JMenuItem("Save As");
         miSaveAs.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_S,InputEvent.SHIFT_DOWN_MASK+InputEvent.CTRL_DOWN_MASK));
         miSaveAs.addActionListener(new ActionListener(){
             public void actionPerformed(ActionEvent e){
                 File file = openChooser(true);
                 Context c = new Context();
                 c.setFile(file);
                 commands.get(CmdSaveAs.class).execute(c);
             }
         });
         muFile.add(miSaveAs);
         
         
         
         mb.add(muFile);
 
         // |--+ {Format} Menu
         JMenu muFormat = new JMenu("Format");
         //    |--{Indent} Menu Item
         JMenuItem miIndent = new JMenuItem("Indent");
         miIndent.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_I,InputEvent.CTRL_DOWN_MASK+InputEvent.ALT_DOWN_MASK));
         miIndent.addActionListener(new ActionListener(){
             public void actionPerformed(ActionEvent e){
                 Context c = new Context();
                 c.setboolean(false);
                 commands.get(CmdIndent.class).execute(c);
             }
         });
         muFormat.add(miIndent);
         JMenuItem miIndentAll = new JMenuItem("Indent All");
         miIndentAll.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_I,InputEvent.CTRL_DOWN_MASK+InputEvent.ALT_DOWN_MASK));
         miIndentAll.addActionListener(new ActionListener(){
             public void actionPerformed(ActionEvent e){
                 Context c = new Context();
                 c.setboolean(true);
                 commands.get(CmdIndent.class).execute(c);
             }
         });
         muFormat.add(miIndentAll);
         JMenuItem miWellFormed = new JMenuItem("Check Well Formed");
         miWellFormed.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_W,InputEvent.CTRL_DOWN_MASK));
         miWellFormed.addActionListener(new ActionListener(){
             public void actionPerformed(ActionEvent e){
                 commands.get(CmdWellFormed.class).execute(new Context());
             }
         });
         muFormat.add(miWellFormed);
         
         mb.add(muFormat);
         
         // |--+ {Insert} Menu
         JMenu muInsert = new JMenu("Insert");
         //      |--{Header} Menu Item
         JMenuItem miHeader = new JMenuItem("Header");
         miHeader.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_H,InputEvent.CTRL_DOWN_MASK));
         miHeader.addActionListener(new ActionListener(){
             public void actionPerformed(ActionEvent e){
                 getHeaderLevel();
             }
         });
         muInsert.add(miHeader);
         //      |--{List} Menu Item
         JMenuItem miList = new JMenuItem("List");
         miList.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_L,InputEvent.CTRL_DOWN_MASK));
         miList.addActionListener(new ActionListener(){
             public void actionPerformed(ActionEvent e){
                 getListProperties();
             }
         });
         muInsert.add(miList);
         //      |--{Table} Menu Item
         JMenuItem miTable = new JMenuItem("Table");
         miTable.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_T,InputEvent.CTRL_DOWN_MASK));
         miTable.addActionListener(new ActionListener(){
             public void actionPerformed(ActionEvent e){
                 getTableSize();
             }
         });
         muInsert.add(miTable);
         //      |--+ {Text} Menu
         JMenu muText = new JMenu("Text");
         //          |--{Bold} Menu Item
         JMenuItem miBold = new JMenuItem("Bold");
         miBold.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_B,InputEvent.CTRL_DOWN_MASK));
         miBold.addActionListener(new ActionListener(){
             public void actionPerformed(ActionEvent e){
                 Context c = new Context();
                 c.setHtmlconst(new Bold());
                 commands.get(CmdInsert.class).execute(c);
             }
         });
         muText.add(miBold);
         //          |--{Italic} Menu Item
         JMenuItem miItalic = new JMenuItem("Italic");
         miItalic.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_I,InputEvent.CTRL_DOWN_MASK));
         miItalic.addActionListener(new ActionListener(){
             public void actionPerformed(ActionEvent e){
                 Context c = new Context();
                 c.setHtmlconst(new Italic());
                 commands.get(CmdInsert.class).execute(c);
             }
         });
         muText.add(miItalic);
         //          |--{Strikethrough} Menu Item
         JMenuItem miStrike = new JMenuItem("Strikethrough");
         miStrike.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_S,InputEvent.CTRL_DOWN_MASK+InputEvent.ALT_DOWN_MASK));
         miStrike.addActionListener(new ActionListener(){
             public void actionPerformed(ActionEvent e){
                 Context c = new Context();
                 c.setHtmlconst(new Strikethrough());
                 commands.get(CmdInsert.class).execute(c);
             }
         });
         muText.add(miStrike);
         //          |--{Underline} Menu Item
         JMenuItem miUnderline = new JMenuItem("Underline");
         miUnderline.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_U,InputEvent.CTRL_DOWN_MASK));
         miUnderline.addActionListener(new ActionListener(){
             public void actionPerformed(ActionEvent e){
                 Context c = new Context();
                 c.setHtmlconst(new Underline());
                 commands.get(CmdInsert.class).execute(c);
             }
         });
         muText.add(miUnderline);
         muInsert.add(muText);
 
         
         mb.add(muInsert);
         
         setJMenuBar(mb);
         this.add(tabs);
 
         setTitle("htmledit");
 
         setSize(new Dimension(500, 500));
         setLocationRelativeTo(null);
 
     }
     /**
      * updates the list of tabs that are open
      * closes tabs that are no longer open
      * opens new tabs for files that were open
      * 
      * @param obs - the session
      * @param obj
      */
     @Override
     public void update(Observable obs, Object obj)
     {
         if(obs instanceof Session){
             Session session = (Session)(obs);
             ArrayList<HTMLBuffer> bufferList = new ArrayList<HTMLBuffer>(session.bufferList);
             ArrayList<HTMLBuffer> currentList = new ArrayList<HTMLBuffer>();
             for (int i=0; i < tabs.getTabCount();i++){
                 currentList.add((HTMLBuffer)(tabs.getComponentAt(i)));
             }
             for( int i = 0; i < bufferList.size();i++){
                 if(currentList.contains(bufferList.get(i))){
                     //remove tabs that are in both because they have not changed
                     currentList.remove(bufferList.get(i));
                     bufferList.remove(i);
                 }
             }
             
             if(currentList.size() >0){
                 for(int i=0;i<currentList.size();i++){
                     //remove tabs from view that are no longer in the bufferList
                     tabs.remove(tabs.indexOfComponent(currentList.get(i)));
                 }
             }
             
             if(bufferList.size() > 0){
                 //add new tabs for the new views
                 for (int i=0;i < bufferList.size();i++){
                     newTab(bufferList.get(i));
                 }
             }
         }else if ( obs instanceof Mailbox){
             Mailbox mailbox = (Mailbox)(obs);
             while(mailbox.hasMail()){
                 Mail m = mailbox.readMessage();
                 if(m.getMailType() == MailType.UNSAVED_CHANGES){
                     tabs.setSelectedComponent(m.getBuf());
                     
                 }else if(m.getMailType() == MailType.WELL_FORMED_ERROR){
                     tabs.setSelectedComponent(m.getBuf());
                     wellFormedDialog(false);
                 }
             }
         }
         
     }
     
 
     
     /**
      * Opens the file chooser for the user, and returns the file object, or null if cancelled
      * 
      * @param save - whether or not the chooser is being open to save a file
      * @return File - the file chosen 
      */
     public File openChooser(boolean save){
         JFileChooser chooser = new JFileChooser("~/");
         chooser.setMultiSelectionEnabled(false);
         int returnValue;
         if( save == true){
             returnValue = chooser.showSaveDialog(this);
         }else{
             returnValue = chooser.showOpenDialog(this);   
         }
         
         if(returnValue == JFileChooser.APPROVE_OPTION){
             File file = chooser.getSelectedFile();
             return file;
         }
         return null;
         
     }
     /**
      * Opens a GUI popup to get the dimensions for the table
      *  and executes the insert command
      */
     public void getTableSize(){
         final int[] dimensions = new int[2];
         final JFrame frame = new JFrame();
         frame.setLocationRelativeTo(this);
         frame.setLayout(new BorderLayout());
         frame.setDefaultCloseOperation(DISPOSE_ON_CLOSE);
         JLabel label = new JLabel("Table Dimensions");
         frame.add(label, BorderLayout.NORTH);
         JPanel pane = new JPanel();
         pane.setLayout(new GridLayout(2,2));
         JLabel len = new JLabel("Rows");
         pane.add(len);
         final JTextField rows = new JTextField();
         pane.add(rows);
         JLabel wid = new JLabel("Columns");
         pane.add(wid);
         final JTextField cols = new JTextField();
         pane.add(cols);
         frame.add(pane, BorderLayout.CENTER);
         JPanel buttons = new JPanel();
         buttons.setLayout(new GridLayout(1,2));
         JButton cancel = new JButton("Cancel");
         JButton confirm = new JButton("Confirm");
         confirm.addActionListener(new ActionListener(){
             public void actionPerformed(ActionEvent e){
                 dimensions[0] = Integer.parseInt(rows.getText());
                 dimensions[1] = Integer.parseInt(cols.getText());
                 Context c = new Context();
                 c.setHtmlconst(new Table(dimensions[0],dimensions[1]));
                 commands.get(CmdInsert.class).execute(c);
                 frame.dispose();
             }
         });
         cancel.addActionListener(new ActionListener(){
             public void actionPerformed(ActionEvent e){ 
                 frame.dispose();
             }
         });
         
         buttons.add(cancel);
         buttons.add(confirm);
         frame.add(buttons, BorderLayout.SOUTH);
         frame.setTitle("Table Size");
         frame.pack();
         frame.setVisible(true);
         
         
     }
     
     /**
      * Opens a GUI popup to get list properties and executes the insert command
      */
     public void getListProperties(){
         listType="u";
         final JFrame frame = new JFrame();
         frame.setLocationRelativeTo(this);
         frame.setTitle("List Properties");
         frame.setDefaultCloseOperation(DISPOSE_ON_CLOSE);
         frame.setLayout(new GridLayout(3,1));
         JRadioButton u = new JRadioButton("Unordered",true);
         JRadioButton o = new JRadioButton("Ordered");        
         JRadioButton d = new JRadioButton("Definition");
         JPanel buttons = new JPanel(new GridLayout(1,3));
         u.addActionListener(new ActionListener(){
            public void actionPerformed(ActionEvent e){
                listType = "u";
            }
         });
         o.addActionListener(new ActionListener(){
             public void actionPerformed(ActionEvent e){
                 listType = "o";
             }
          });
         d.addActionListener(new ActionListener(){
             public void actionPerformed(ActionEvent e){
                 listType="d";
             }
          });
         ButtonGroup btnGroup = new ButtonGroup();
         btnGroup.add(u);
         btnGroup.add(o);
         btnGroup.add(d);
         buttons.add(u);
         buttons.add(o);
         buttons.add(d);
         frame.add(buttons);
         JPanel len = new JPanel(new GridLayout(1,2));
         len.add(new JLabel("List Length"));
         final JTextField length = new JTextField();
         len.add(length);
         frame.add(len);
         JPanel choices = new JPanel(new GridLayout(1,2));
         JButton cancel = new JButton("Cancel");
         JButton confirm = new JButton("Confirm");
         confirm.addActionListener(new ActionListener(){
             public void actionPerformed(ActionEvent e){
                 Context c = new Context();
                 c.setHtmlconst(new List(Integer.parseInt(length.getText()),listType));
                 commands.get(CmdInsert.class).execute(c);
                 frame.dispose();
             }
         });
         cancel.addActionListener(new ActionListener(){
             public void actionPerformed(ActionEvent e){ 
                 frame.dispose();
             }
         });
         choices.add(cancel);
         choices.add(confirm);
         
         frame.add(choices);
         frame.pack();
         frame.setVisible(true);
         
     }
     
     /**
      * Opens a GUI popup to get the header level and executes the insert command
      */
     public void getHeaderLevel(){
         final JFrame frame = new JFrame();
         frame.setLocationRelativeTo(this);
         frame.setDefaultCloseOperation(DISPOSE_ON_CLOSE);
         frame.setLayout(new GridLayout(2,1));
         frame.setTitle("Header Level Selection");
         final JComboBox list = new JComboBox();
         for(int i = 1;i<=7;i++){
             list.addItem(i);
         }
         frame.add(list);
         JPanel choices = new JPanel(new GridLayout(1,2));
         JButton cancel = new JButton("Cancel");
         JButton confirm = new JButton("Confirm");
         confirm.addActionListener(new ActionListener(){
             public void actionPerformed(ActionEvent e){
                 Context c = new Context();
                 c.setHtmlconst(new Header(list.getSelectedIndex()+1));
                 commands.get(CmdInsert.class).execute(c);
                 frame.dispose();
             }
         });
         cancel.addActionListener(new ActionListener(){
             public void actionPerformed(ActionEvent e){ 
                 frame.dispose();
             }
         });
         choices.add(cancel);
         choices.add(confirm);
         
         frame.add(choices);
         frame.pack();
         frame.setVisible(true);
         
     }
     
     /**
      * Popup for the wellformed check result
      * @param type - pass or fail
      */
     public void wellFormedDialog(boolean type){
         if( type == false){
             JOptionPane.showMessageDialog(this, "HTML Well Formed Check Failed", "Well Formed Check", JOptionPane.ERROR_MESSAGE);
         }else{
             JOptionPane.showMessageDialog(this, "HTML Well Formed Check Passed", "Well Formed Check", JOptionPane.PLAIN_MESSAGE);
         }
     }
     
     /**
      * Adds a new tab to the tabbedPane to be viewed in the GUI
      * @param buffer - the new buffer to be added to the view
      */
     public void newTab(HTMLBuffer buffer){
         String title = buffer.getFile().getName();
         tabs.addTab(title, buffer);
         int index = tabs.indexOfComponent(buffer);
         JPanel tabPanel = new JPanel();
         tabPanel.setLayout(new GridLayout(1,2));
         tabPanel.add(new JLabel(title));
         JButton closeButton = new JButton("x");
         closeButton.addActionListener(new CloseButtonHandler(buffer));
         tabPanel.add(closeButton);
         
         tabs.setTabComponentAt(index, tabPanel);
         
     }
     
     /**
      * 
      * @author Harris
      *
      *Small class to handle the tab close button
      */
     public class CloseButtonHandler implements ActionListener{
         private HTMLBuffer buffer;
         public CloseButtonHandler(HTMLBuffer buffer){
             this.buffer = buffer;
         }
         /**
          * Executes the close command
          */
         public void actionPerformed(ActionEvent e){
             Context c = new Context();
             c.setBuffer(buffer);
             commands.get(CmdClose.class).execute(c);
         }
     }
 
 }
