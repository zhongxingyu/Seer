 import java.io.BufferedReader;
 import java.io.File;
 import java.io.FileInputStream;
 import java.io.FileOutputStream;
 import java.io.IOException;
 import java.io.InputStreamReader;
 import java.io.OutputStreamWriter;
 import java.util.ArrayList;
 import java.util.List;
 import java.util.regex.Matcher;
 import java.util.regex.Pattern;
 
 public class MixSubs {
 
 	public static List<SrtPhrase> parseSrtFile(String path, String style)
 	        throws IOException {
 		final String nl = "\\\n";
 		final String sp = "[ \\t]*";
 
 		Pattern entirePhrasePattern = Pattern.compile("(?s)(\\d+)" + sp + nl
 		        + "(\\d{1,2}):(\\d\\d):(\\d\\d),(\\d\\d\\d)" + sp + "-->" + sp
 		        + "(\\d\\d):(\\d\\d):(\\d\\d),(\\d\\d\\d)" + sp
 		        + "(X1:\\d.*?)??" + nl + "(.*?)" + nl + nl);
 
 		Pattern phraseStartTimePattern = Pattern
 		        .compile("(\\d{1,2}):(\\d\\d):(\\d\\d),(\\d\\d\\d)" + sp);
 
 		Pattern phraseStopTimePattern = Pattern.compile("-->" + sp
 		        + "(\\d\\d):(\\d\\d):(\\d\\d),(\\d\\d\\d)");
 
 		StringBuilder sourceFile = new StringBuilder();
 		BufferedReader reader = new BufferedReader(new InputStreamReader(
 		        new FileInputStream(path), "UTF-8"));
 
 		String line;
 		sourceFile.append("\n");
 		while ((line = reader.readLine()) != null) {
 			sourceFile.append(line);
 			sourceFile.append("\n");
 		}
 		reader.close();
 
 		Matcher entirePhraseMatcher = entirePhrasePattern.matcher(sourceFile
 		        .toString());
 
 		List<String> nonParsedPhrases = new ArrayList<String>();
 
 		while (entirePhraseMatcher.find()) {
 			nonParsedPhrases.add(entirePhraseMatcher.group());
 		}
 
 		List<SrtPhrase> parsedPhrases = new ArrayList<SrtPhrase>();
 
 		for (String nonParsedPhrase : nonParsedPhrases) {
 			SrtPhrase srtPhrase = new SrtPhrase();
 
 			Matcher phraseStartTimeMatcher = phraseStartTimePattern
 			        .matcher(nonParsedPhrase.toString());
 			phraseStartTimeMatcher.find();
 
 			Matcher phraseStopTimeMatcher = phraseStopTimePattern
 			        .matcher(nonParsedPhrase.toString());
 			phraseStopTimeMatcher.find();
 
 			srtPhrase.setNumber(new Integer(nonParsedPhrase.split("\n")[0]));
 			srtPhrase.setNonParsedStartTime(phraseStartTimeMatcher.group());
 			srtPhrase.setNonParsedStopTime(phraseStopTimeMatcher.group()
 			        .substring(4));
 			srtPhrase.setPhrase(nonParsedPhrase
 			        .split("(\\d{1,2}):(\\d\\d):(\\d\\d),(\\d\\d\\d)" + sp
 			                + "-->" + sp
 			                + "(\\d\\d):(\\d\\d):(\\d\\d),(\\d\\d\\d)")[1]
 			        .trim().replace("\n", "\\N"));
 			srtPhrase.setStyle(style);
 
 			parsedPhrases.add(srtPhrase);
 		}
 
 		return parsedPhrases;
 	}
 
 	public static void main(String[] args) throws IOException {
 		String lowerTrackPath;
 		String upperTrackPath;
 		String outputFilePath;
 
 		if (args.length == 3) {
 			lowerTrackPath = args[0].replace("\\", "\\\\");
 			upperTrackPath = args[1].replace("\\", "\\\\");
 			outputFilePath = args[2].replace("\\", "\\\\");
 		} else if (args.length == 2) {
 			lowerTrackPath = args[0].replace("\\", "\\\\");
 			upperTrackPath = args[1].replace("\\", "\\\\");
 			outputFilePath = "mixed-output.ass";
 		} else {
 			throw new IOException("invalid arguments " + args);
 		}
 
		List<SrtPhrase> upperPhrases = parseSrtFile(lowerTrackPath, "Upper");
		List<SrtPhrase> lowerPhrases = parseSrtFile(upperTrackPath, "Lower");
 
 		List<SrtPhrase> allPhrases = new ArrayList<SrtPhrase>();
 		allPhrases.addAll(lowerPhrases);
 		allPhrases.addAll(upperPhrases);
 		upperPhrases.addAll(lowerPhrases);
 
 //		for (SrtPhrase srtPhrase : allPhrases) {
 //			System.out.println(srtPhrase);
 //		}
 
 		String ASSHeader = "[Script Info]\n"
 		        + "; Script generated by garygg42 SrtMixer\n"
 		        + "Title: Default Aegisub file\n"
 		        + "ScriptType: v4.00+\n"
 		        + "WrapStyle: 0\n"
 		        + "ScaledBorderAndShadow: yes\n"
 		        + "Collisions: Normal\n"
 		        + "Last Style Storage: Default\n"
 		        + "Scroll Position: 771\n"
 		        + "Active Line: 783\n"
 		        + "Video Zoom Percent: 1\n"
 		        + "YCbCr Matrix: None\n"
 		        + "\n"
 		        + "[V4+ Styles]\n"
 		        + "Format: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding\n"
 		        + "Style: Default,Arial,20,&H00FFFFFF,&H000000FF,&H00000000,&H00000000,0,0,0,0,100,100,0,0,1,2,2,2,10,10,10,1\n"
 		        + "Style: Lower,Arial,20,&H00FFFFFF,&H000000FF,&H00000000,&H00000000,0,0,0,0,100,100,0,0,1,2,2,2,10,10,10,1\n"
 		        + "Style: Upper,Arial,20,&H00FFFFFF,&H000000FF,&H00000000,&H00000000,0,0,0,0,100,100,0,0,1,2,2,8,10,10,10,1\n"
 		        + "\n"
 		        + "[Events]\n"
 		        + "Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text\n";
 
 		File file = new File(outputFilePath);
 		if (file.exists()) {
 			file.delete();
 			file.createNewFile();
 		} else {
 			file.createNewFile();
 		}
 
 		OutputStreamWriter out = new OutputStreamWriter(new FileOutputStream(
 		        file));
 
 		out.write(ASSHeader);
 
 		for (SrtPhrase phrase : allPhrases) {
 			out.write("Dialogue: 0," + phrase.getStartTime() + ","
 			        + phrase.getStopTime() + "," + phrase.getStyle()
 			        + ",,0000,0000,0000,," + phrase.getPhrase() + "\n");
 		}
 
 		out.flush();
 		out.close();
 
 //		System.out.println("Finished");
 
 	}
 }
